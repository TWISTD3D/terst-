<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>snow</title>
<link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@300;400;500;600;700&family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

const firebaseConfig = {
  apiKey:            "AIzaSyDcGq4UF6wqKLcI7zidskV8OKOM06AUDTM",
  authDomain:        "server-19034.firebaseapp.com",
  databaseURL:       "https://server-19034-default-rtdb.firebaseio.com",
  projectId:         "server-19034",
  storageBucket:     "server-19034.firebasestorage.app",
  messagingSenderId: "860267587022",
  appId:             "1:860267587022:web:83c5629f49a58789d1379f"
};

try {
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const profileRef = ref(db, 'profile');

  window._fbSet = (data) => set(profileRef, data);
  window._fbPending = null;

  onValue(profileRef, (snap) => {
    const d = snap.exists() ? snap.val() : null;
    if (!d) return;
    if (window.applyProfileData) {
      window.applyProfileData(d);
    } else {
      window._fbPending = d;
    }
  }, (err) => console.warn('Firebase read error:', err));

  window._fbReady = true;
  console.log('Firebase connected ✓');
} catch(e) {
  console.warn('Firebase init failed:', e);
}
</script>
<style>
  :root {
    --bg: #080e1e;
    --card: rgba(12,20,48,0.80);
    --border: rgba(80,180,255,0.30);
    --border-h: rgba(100,210,255,0.45);
    --text: #dff0ff;
    --muted: #6090b8;
    --accent: #50b4ff;
    --accent2: #38d4ff;
    --accent3: #90dcff;
    --glow: rgba(80,180,255,0.55);
    --red: #70c8ff;
    --green: #40e8ff;
    --c1r:80;--c1g:180;--c1b:255;
    --c2r:56;--c2g:212;--c2b:255;
    --c3r:144;--c3g:220;--c3b:255;
  }
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
  html,body{width:100%;height:100%;overflow:hidden;font-family:'DM Mono',monospace;background:var(--bg);color:var(--text);cursor:none}
  #bg-video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;display:none}
  #bg-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:0}
  .bg-overlay{position:fixed;inset:0;z-index:1;transition:opacity .5s;
    background:radial-gradient(ellipse 65% 55% at 15% 15%,rgba(60,160,240,0.08) 0%,transparent 55%),
    radial-gradient(ellipse 55% 50% at 85% 85%,rgba(80,180,255,0.07) 0%,transparent 55%),
    linear-gradient(160deg,rgba(14,12,28,0.85) 0%,rgba(10,13,26,0.65) 50%,rgba(8,12,24,0.88) 100%)}
  #scene{position:fixed;inset:0;z-index:2;display:flex;align-items:center;justify-content:center;perspective:1000px}
  .card-wrap{transform-style:preserve-3d;will-change:transform}

  .card{width:430px;background:var(--card);border:1px solid var(--border);border-radius:18px;backdrop-filter:blur(48px) saturate(170%);
    box-shadow:0 0 0 1px rgba(80,180,255,0.06),0 24px 64px rgba(0,0,0,0.50),0 0 40px rgba(80,180,255,0.09),inset 0 1px 0 rgba(255,255,255,0.06);
    overflow:hidden;animation:cardIn .9s cubic-bezier(.16,1,.3,1) both;transition:box-shadow 0.1s ease}
  @keyframes cardIn{from{opacity:0;transform:translateY(32px) scale(.96)}to{opacity:1;transform:none}}

  .banner{height:70px;position:relative;overflow:hidden;border-bottom:1px solid rgba(80,180,255,0.09);
    background:linear-gradient(135deg,rgba(60,160,240,0.16) 0%,rgba(80,180,255,0.12) 50%,rgba(144,220,255,0.09) 100%);transition:background 0.8s}
  .banner-grid{position:absolute;inset:0;background-size:28px 28px;animation:gridSlide 22s linear infinite;
    background-image:linear-gradient(rgba(80,180,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(60,160,240,0.04) 1px,transparent 1px)}
  @keyframes gridSlide{from{background-position:0 0}to{background-position:26px 26px}}
  .banner-glow{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 170%,rgba(60,160,240,0.22) 0%,transparent 55%);transition:background 0.8s}
  .banner-orb{position:absolute;border-radius:50%;filter:blur(28px);transition:background 0.8s,transform 0.05s}
  @keyframes orbFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-8px) scale(1.04)}}
  .banner-orb.b1{width:90px;height:90px;background:rgba(80,180,255,0.32);top:-30px;left:28%;animation:orbFloat 6s ease-in-out infinite}
  .banner-orb.b2{width:65px;height:65px;background:rgba(56,212,255,0.24);top:-15px;right:22%;animation:orbFloat 7.5s ease-in-out infinite reverse}
  .banner-orb.b3{width:50px;height:50px;background:rgba(144,220,255,0.20);top:-20px;left:55%;animation:orbFloat 5s ease-in-out infinite 1.2s}

  .profile-wrap{padding:0 20px 18px;position:relative}
  .avatar-outer{position:absolute;top:-44px;left:22px;width:84px;height:84px}
  .avatar-ring{position:absolute;inset:-3px;border-radius:50%;background:conic-gradient(#50b4ff,#90dcff,#2090e8,#40e8ff,#50b4ff);animation:ringRotate 5s linear infinite;z-index:0;transition:background 0.8s}
  @keyframes ringRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .avatar-ring::before{content:'';position:absolute;inset:2px;border-radius:50%;background:#0e1220}
  .avatar-img{position:relative;z-index:1;width:84px;height:84px;border-radius:50%;border:2.5px solid #0e1220;background:linear-gradient(135deg,#131a30,#1e2445);display:flex;align-items:center;justify-content:center;overflow:hidden;transition:transform .3s;font-size:.65rem;font-family:'Geist Mono',monospace;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
  .avatar-img:hover{transform:scale(1.07)}
  .avatar-img img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .avatar-upload-hint{display:none}
  .avatar-status{position:absolute;bottom:4px;right:4px;width:14px;height:14px;border-radius:50%;background:var(--red);border:2.5px solid #0e1220;z-index:4;transition:background .3s;box-shadow:0 0 6px currentColor}
  .profile-header{padding-top:52px;margin-bottom:10px}
  .username-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px}
  .username{font-family:'Syne',sans-serif;font-size:1.32rem;font-weight:800;color:rgba(235,245,255,0.97);letter-spacing:-.03em;line-height:1}
  .cursor-blink{display:inline-block;width:2px;height:1.1em;background:var(--accent);margin-left:1px;vertical-align:text-top;animation:blink 1s step-end infinite;border-radius:1px;transition:background 0.8s}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
  .badges{display:flex;gap:3px;flex-wrap:wrap;align-items:center}
  .badge{display:inline-flex;align-items:center;height:19px;padding:0 8px;border-radius:5px;background:rgba(80,180,255,0.07);border:1px solid rgba(80,180,255,0.15);font-size:.57rem;font-family:'Geist Mono',monospace;letter-spacing:1px;text-transform:uppercase;color:rgba(80,180,255,0.65);cursor:default;transition:all .18s;user-select:none;white-space:nowrap}
  .badge:hover{transform:translateY(-2px)}
  .status-row{display:flex;align-items:center;gap:6px;margin-bottom:10px}
  .status-dot{width:7px;height:7px;border-radius:50%;background:var(--red);flex-shrink:0;box-shadow:0 0 6px currentColor;transition:background .3s}
  .status-text{font-size:.6rem;color:var(--muted);font-family:'Geist Mono',monospace;letter-spacing:2.5px;text-transform:uppercase}
  .bio{font-size:.76rem;color:rgba(185,215,250,0.60);line-height:1.7;min-height:22px;margin-bottom:14px;font-family:'DM Mono',monospace}
  .bio-cursor{display:inline-block;width:1.5px;height:.95em;background:var(--accent2);margin-left:1px;vertical-align:middle;border-radius:1px;animation:blink .9s step-end infinite;transition:background 0.8s}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(80,180,255,0.14),rgba(60,160,240,0.14),transparent);margin-bottom:16px;transition:background 0.8s}
  .socials{display:flex;gap:7px;justify-content:center;margin-bottom:16px}
  .social-btn{height:29px;padding:0 11px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);display:flex;align-items:center;cursor:none;transition:all .22s cubic-bezier(.34,1.56,.64,1);color:var(--muted);text-decoration:none;font-family:'Geist Mono',monospace;font-size:.57rem;letter-spacing:1.5px;text-transform:uppercase;gap:6px;white-space:nowrap}
  .social-btn:hover{background:rgba(80,180,255,0.09);border-color:rgba(80,180,255,0.26);color:var(--accent);transform:translateY(-3px) scale(1.05);box-shadow:0 6px 18px rgba(80,180,255,0.1)}
  .social-btn svg{width:11px;height:11px;fill:currentColor;flex-shrink:0}
  .view-count{display:flex;align-items:center;gap:6px;font-family:'Geist Mono',monospace;font-size:.6rem;color:var(--muted);padding:6px 0 0;letter-spacing:1px}
  .view-count-dot{width:5px;height:5px;border-radius:50%;background:var(--accent2);opacity:.7;flex-shrink:0;transition:background 0.8s}

  .music-section{padding:12px 20px 16px;border-top:1px solid rgba(80,180,255,0.08);background:rgba(0,0,0,0.12)}
  .music-label{font-family:'Geist Mono',monospace;font-size:.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:8px}
  .music-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}
  .music-eq{display:flex;align-items:flex-end;gap:2px;height:14px}
  .eq-b{width:2.5px;border-radius:1px;min-height:2px;transition:height 0.06s ease,background 0.8s}
  .now-playing-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .album{width:48px;height:48px;border-radius:9px;background:linear-gradient(135deg,#0e1428,#192040);border:1px solid rgba(80,180,255,0.10);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .3s;overflow:hidden;position:relative}
  .album img.album-cover{width:100%;height:100%;object-fit:cover;border-radius:9px}
  .album-initials{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;color:rgba(80,180,255,0.38);letter-spacing:.5px;text-transform:uppercase;text-align:center;padding:4px;line-height:1.2}
  .track-info{flex:1;min-width:0}
  .track-title{font-family:'Syne',sans-serif;font-size:.86rem;font-weight:700;color:rgba(218,232,255,0.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:1px}
  .track-artist{font-family:'Geist Mono',monospace;font-size:.62rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.5px}
  .track-album{font-family:'DM Mono',monospace;font-size:.57rem;color:rgba(100,120,160,0.55);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;font-style:italic}
  .prog-wrap{position:relative;margin-bottom:10px;cursor:none}
  .prog-track{height:3px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden}
  .prog-fill{height:100%;width:0%;background:linear-gradient(90deg,#50b4ff,#2090e8,#90dcff);border-radius:2px;transition:width .15s linear,background 0.8s;position:relative}
  .prog-fill::after{content:'';position:absolute;right:-4px;top:-4px;width:10px;height:10px;background:var(--accent);border-radius:50%;opacity:0;transition:opacity .2s;box-shadow:0 0 8px var(--accent)}
  .prog-wrap:hover .prog-fill::after{opacity:1}
  .prog-times{display:flex;justify-content:space-between;font-family:'Geist Mono',monospace;font-size:.55rem;color:var(--muted);margin-top:4px;letter-spacing:.5px}
  .controls{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:12px}
  .ctrl{width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:none;transition:all .18s;user-select:none}
  .ctrl:hover{background:rgba(80,180,255,0.08);color:var(--accent);border-color:rgba(80,180,255,0.22)}
  .ctrl.on{color:var(--accent2);border-color:rgba(60,160,240,0.33);background:rgba(60,160,240,0.09)}
  .ctrl.pp{width:40px;height:40px;border-radius:50%;background:rgba(80,180,255,0.1);border-color:rgba(80,180,255,0.28);color:var(--accent);transition:all .18s,background 0.8s}
  .ctrl.pp:hover{background:rgba(80,180,255,0.2);box-shadow:0 0 24px rgba(80,180,255,0.2);transform:scale(1.08)}
  .ctrl svg{width:13px;height:13px;fill:currentColor}
  .song-selector{display:flex;gap:5px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  .song-dot{min-width:26px;height:20px;border-radius:5px;background:rgba(255,255,255,0.02);border:1px solid rgba(80,180,255,0.09);font-family:'Geist Mono',monospace;font-size:.53rem;font-weight:600;color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:none;transition:all .18s cubic-bezier(.34,1.56,.64,1);padding:0 6px;user-select:none;letter-spacing:1px}
  .song-dot:hover{border-color:rgba(80,180,255,0.26);color:var(--accent);transform:translateY(-2px)}
  .song-dot.active{background:rgba(80,180,255,0.14);border-color:rgba(80,180,255,0.38);color:var(--accent);box-shadow:0 0 12px rgba(80,180,255,0.12)}
  .sliders-row{display:flex;align-items:center;gap:14px}
  .slider-group{display:flex;align-items:center;gap:8px;flex:1}
  .slider-label{font-family:'Geist Mono',monospace;font-size:.52rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);flex-shrink:0;cursor:none;transition:color .15s;user-select:none;min-width:22px;text-align:center}
  .slider-label:hover{color:var(--accent)}
  input[type=range].custom-slider{-webkit-appearance:none;width:100%;height:3px;background:rgba(255,255,255,0.07);border-radius:2px;outline:none;cursor:none}
  input[type=range].custom-slider::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:var(--accent);border-radius:50%;cursor:none;transition:transform .15s,background 0.8s;box-shadow:0 0 8px rgba(80,180,255,0.45)}
  input[type=range].custom-slider:hover::-webkit-slider-thumb{transform:scale(1.3)}

  #cursor-dot{position:fixed;top:0;left:0;width:7px;height:7px;border-radius:50%;background:var(--accent);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);mix-blend-mode:screen;box-shadow:0 0 8px var(--accent);transition:background 0.4s,box-shadow 0.4s}
  #cursor-ring{position:fixed;top:0;left:0;width:26px;height:26px;border-radius:50%;border:1.5px solid rgba(80,180,255,0.45);pointer-events:none;z-index:9998;transform:translate(-50%,-50%);transition:border-color 0.4s}
  .trail-dot{position:fixed;pointer-events:none;z-index:9997;border-radius:50%;transform:translate(-50%,-50%);mix-blend-mode:screen}

  .overlay-base{position:fixed;inset:0;z-index:50;display:none;align-items:center;justify-content:center;background:rgba(5,7,18,0.78);backdrop-filter:blur(18px)}
  .overlay-base.open{display:flex}
  @keyframes panelIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:none}}

  .pw-box{width:320px;background:rgba(12,15,30,0.98);border:1px solid var(--border-h);border-radius:20px;padding:34px 28px;box-shadow:0 30px 80px rgba(0,0,0,0.8);animation:panelIn .3s cubic-bezier(.16,1,.3,1);text-align:center}
  .pw-lock{font-family:'Geist Mono',monospace;font-size:.6rem;letter-spacing:4px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:8px}
  .pw-lock::before,.pw-lock::after{content:'';flex:1;height:1px;background:var(--border)}
  .pw-title{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:800;margin-bottom:4px;color:rgba(220,235,255,0.9)}
  .pw-sub{font-family:'Geist Mono',monospace;font-size:.6rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:22px;text-transform:uppercase}
  .pw-error{font-family:'Geist Mono',monospace;font-size:.64rem;color:var(--red);margin-bottom:8px;min-height:16px;letter-spacing:.5px}
  .pw-input{width:100%;padding:11px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border-h);border-radius:10px;color:var(--text);font-family:'Geist Mono',monospace;font-size:.9rem;letter-spacing:3px;outline:none;text-align:center;transition:border-color .2s,box-shadow .2s;margin-bottom:10px;cursor:none}
  .pw-input:focus{border-color:rgba(60,160,240,0.4);box-shadow:0 0 0 3px rgba(60,160,240,0.07)}
  .pw-input.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97);border-color:rgba(240,168,180,0.55)!important}
  @keyframes shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
  .pw-btn{width:100%;padding:11px;background:rgba(60,160,240,0.1);border:1px solid rgba(60,160,240,0.24);border-radius:10px;color:var(--accent2);font-family:'Syne',sans-serif;font-size:.84rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:none;transition:all .2s;margin-bottom:8px}
  .pw-btn:hover{background:rgba(60,160,240,0.18);box-shadow:0 0 22px rgba(60,160,240,0.12)}
  .pw-cancel{font-family:'Geist Mono',monospace;font-size:.64rem;color:var(--muted);cursor:none;transition:color .15s;letter-spacing:2px;text-transform:uppercase;display:inline-block;margin-top:4px}
  .pw-cancel:hover{color:var(--text)}

  .settings-panel{width:460px;max-height:90vh;overflow-y:auto;background:rgba(12,15,30,0.98);border:1px solid var(--border-h);border-radius:20px;padding:28px;box-shadow:0 30px 80px rgba(0,0,0,0.8);animation:panelIn .3s cubic-bezier(.16,1,.3,1)}
  .settings-panel::-webkit-scrollbar{width:4px}
  .settings-panel::-webkit-scrollbar-thumb{background:rgba(60,160,240,0.18);border-radius:2px}
  .sp-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
  .sp-title{font-family:'Syne',sans-serif;font-size:1.08rem;font-weight:800;letter-spacing:-.02em;color:rgba(220,235,255,0.9)}
  .sp-close{width:28px;height:28px;border-radius:7px;background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:none;font-family:'Geist Mono',monospace;font-size:.66rem;transition:all .15s}
  .sp-close:hover{background:rgba(240,168,180,0.1);border-color:rgba(240,168,180,0.28);color:var(--red)}
  .sp-section{margin-bottom:18px}
  .sp-section-title{font-family:'Geist Mono',monospace;font-size:.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .sp-section-title::after{content:'';flex:1;height:1px;background:var(--border)}
  .sp-input{width:100%;padding:9px 12px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'DM Mono',monospace;font-size:.8rem;outline:none;transition:border-color .2s;cursor:none}
  .sp-input:focus{border-color:rgba(60,160,240,0.32)}
  .sp-input::placeholder{color:rgba(102,128,168,0.38)}
  .sp-row{display:flex;gap:8px}
  .sp-row .sp-input{flex:1}
  .sp-add-btn{padding:9px 14px;background:rgba(60,160,240,0.09);border:1px solid rgba(60,160,240,0.2);border-radius:9px;color:var(--accent2);font-family:'Geist Mono',monospace;font-size:.63rem;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:none;white-space:nowrap;transition:all .15s}
  .sp-add-btn:hover{background:rgba(60,160,240,0.16)}
  .sp-save{width:100%;padding:12px;background:linear-gradient(135deg,rgba(80,180,255,0.1),rgba(60,160,240,0.1),rgba(144,220,255,0.07));border:1px solid rgba(60,160,240,0.22);border-radius:10px;color:var(--accent2);font-family:'Geist Mono',monospace;font-size:.72rem;font-weight:600;letter-spacing:3px;text-transform:uppercase;cursor:none;transition:all .2s;margin-top:4px}
  .sp-save:hover{background:linear-gradient(135deg,rgba(80,180,255,0.18),rgba(60,160,240,0.18),rgba(144,220,255,0.12));box-shadow:0 0 28px rgba(60,160,240,0.12);transform:translateY(-1px)}
  .sp-upload{width:100%;padding:14px;border:1px dashed rgba(60,160,240,0.16);border-radius:10px;text-align:center;cursor:none;transition:all .2s;background:transparent;color:var(--muted);font-family:'Geist Mono',monospace;font-size:.63rem;letter-spacing:1px;text-transform:uppercase}
  .sp-upload:hover{border-color:rgba(60,160,240,0.32);color:var(--accent2);background:rgba(60,160,240,0.04)}
  .sp-upload span{display:block;color:var(--accent2);font-weight:600;margin-bottom:2px;font-size:.66rem;letter-spacing:2px}

  .pfp-upload-row{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;margin-bottom:8px}
  .pfp-preview-mini{width:44px;height:44px;border-radius:50%;flex-shrink:0;overflow:hidden;background:linear-gradient(135deg,#131a30,#1e2445);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.55rem;font-family:'Geist Mono',monospace;color:var(--muted);text-transform:uppercase}
  .pfp-preview-mini img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .pfp-btn{flex:1;padding:10px;border:1px dashed rgba(80,180,255,0.22);border-radius:8px;text-align:center;cursor:none;transition:all .2s;background:transparent;color:var(--muted);font-family:'Geist Mono',monospace;font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase}
  .pfp-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(80,180,255,0.05)}
  .pfp-btn span{display:block;color:var(--accent);font-size:.66rem;font-weight:600;margin-bottom:2px;letter-spacing:2px}

  .song-list-sp{display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto;margin-top:8px}
  .song-list-sp::-webkit-scrollbar{width:3px}
  .song-list-sp::-webkit-scrollbar-thumb{background:rgba(60,160,240,0.15);border-radius:2px}
  .song-sp-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border)}
  .song-sp-num{font-family:'Geist Mono',monospace;font-size:.57rem;color:var(--muted);width:16px;flex-shrink:0}
  .song-sp-info{flex:1;min-width:0}
  .song-sp-title{font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;color:rgba(200,220,255,0.78);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .song-sp-meta{font-family:'Geist Mono',monospace;font-size:.57rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
  .song-sp-rm{background:none;border:none;color:rgba(240,168,180,0.4);cursor:none;font-family:'Geist Mono',monospace;font-size:.57rem;padding:2px 6px;border-radius:4px;transition:all .15s;letter-spacing:1px;text-transform:uppercase;flex-shrink:0}
  .song-sp-rm:hover{color:var(--red);background:rgba(240,168,180,0.07)}
  .song-add-form{background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:8px}
  .song-form-row-with-img{display:flex;gap:10px;align-items:flex-end}
  .sp-field-label{font-family:'Geist Mono',monospace;font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;display:block}
  .song-cover-preview{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#101828,#1a2040);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'Geist Mono',monospace;font-size:.48rem;color:var(--muted);cursor:none;overflow:hidden;flex-shrink:0;transition:all .2s;text-transform:uppercase;letter-spacing:.5px;text-align:center}
  .song-cover-preview:hover{border-color:rgba(60,160,240,0.28)}
  .song-cover-preview img{width:100%;height:100%;object-fit:cover;border-radius:7px}
  .badge-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px}
  .badge-slot{display:flex;flex-direction:column;align-items:center;gap:4px;position:relative}
  .badge-slot-preview{width:100%;height:24px;border-radius:6px;background:rgba(255,255,255,0.03);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'Geist Mono',monospace;font-size:.56rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
  .badge-slot-input{width:100%;padding:4px 8px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.7rem;outline:none;font-family:'Geist Mono',monospace;letter-spacing:.5px;transition:border-color .2s;cursor:none}
  .badge-slot-input:focus{border-color:rgba(60,160,240,0.32)}
  .badge-rm-btn{position:absolute;top:-4px;right:-4px;width:14px;height:14px;border-radius:50%;background:rgba(240,168,180,0.6);border:none;color:white;font-family:'Geist Mono',monospace;font-size:.48rem;cursor:none;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .badge-rm-btn:hover{background:var(--red);transform:scale(1.2)}
  .badges-row-controls{display:flex;gap:6px;margin-top:8px}
  .badge-ctrl-btn{flex:1;padding:7px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-family:'Geist Mono',monospace;font-size:.58rem;letter-spacing:1.5px;text-transform:uppercase;cursor:none;transition:all .15s}
  .badge-ctrl-btn:hover{background:rgba(60,160,240,0.08);color:var(--accent2);border-color:rgba(60,160,240,0.18)}
  .icon-edit-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:9px;margin-bottom:6px}
  .icon-edit-label{font-family:'Geist Mono',monospace;font-size:.56rem;color:var(--muted);letter-spacing:1.5px;flex-shrink:0;width:72px;text-transform:uppercase}
  .icon-edit-preview{font-family:'Geist Mono',monospace;font-size:.68rem;flex-shrink:0;width:40px;text-align:center;color:var(--accent2);letter-spacing:.5px}
  .icon-edit-input{flex:1;padding:5px 8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:.78rem;font-family:'Geist Mono',monospace;outline:none;transition:border-color .2s;cursor:none}
  .icon-edit-input:focus{border-color:rgba(60,160,240,0.32)}
  .icon-edit-input::placeholder{color:rgba(102,128,168,0.33)}

  .gear-btn{position:fixed;bottom:44px;right:20px;height:30px;padding:0 13px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--muted);display:flex;align-items:center;gap:6px;cursor:none;font-family:'Geist Mono',monospace;font-size:.56rem;letter-spacing:2px;text-transform:uppercase;z-index:10;transition:all .2s;backdrop-filter:blur(10px)}
  .gear-btn:hover{color:var(--accent);border-color:rgba(80,180,255,0.26)}
  .gear-btn svg{width:10px;height:10px;fill:currentColor;transition:transform .4s}
  .gear-btn:hover svg{transform:rotate(90deg)}

  .toast{position:fixed;bottom:52px;left:50%;transform:translateX(-50%);padding:9px 20px;background:rgba(12,15,30,0.97);border:1px solid rgba(60,160,240,0.22);border-radius:10px;font-family:'Geist Mono',monospace;font-size:.68rem;color:var(--accent2);z-index:200;pointer-events:none;backdrop-filter:blur(12px);white-space:nowrap;animation:toastIn .3s ease,toastOut .3s ease 2s forwards;letter-spacing:1px}
  @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  @keyframes toastOut{to{opacity:0;transform:translateX(-50%) translateY(6px)}}

  #watermark{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);font-size:13px;font-weight:700;font-family:'Geist Mono',monospace;color:rgba(80,180,255,0.28);letter-spacing:2px;text-shadow:0 0 12px rgba(80,180,255,0.35);pointer-events:none;z-index:10;transition:color 0.8s,text-shadow 0.8s;white-space:nowrap;user-select:none}

  .presence-section{padding:10px 22px 14px;border-top:1px solid var(--border);background:rgba(0,0,0,0.1)}
  .presence-label{font-family:'Geist Mono',monospace;font-size:.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .presence-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}
  .presence-dc-dot{width:5px;height:5px;border-radius:50%;background:var(--muted);flex-shrink:0;transition:background .3s;box-shadow:0 0 5px currentColor}
  .activity-row{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(255,255,255,0.025);border:1px solid var(--border);border-radius:10px;min-height:46px;transition:all .3s}
  .activity-row.hidden{display:none}
  .activity-img-wrap{width:40px;height:40px;border-radius:8px;flex-shrink:0;position:relative;background:linear-gradient(135deg,#111830,#1c2248);border:1px solid var(--border);overflow:visible}
  .activity-img{width:40px;height:40px;border-radius:8px;object-fit:cover;display:block}
  .activity-img-small{position:absolute;bottom:-4px;right:-4px;width:16px;height:16px;border-radius:50%;border:2px solid #0d0f1a;object-fit:cover;background:#111830}
  .activity-info{flex:1;min-width:0}
  .activity-name{font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;color:rgba(218,232,255,0.88);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:1px}
  .activity-detail{font-family:'Geist Mono',monospace;font-size:.6rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.3px}
  .activity-state{font-family:'DM Mono',monospace;font-size:.57rem;color:rgba(100,120,160,0.55);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;font-style:italic}
  .spotify-prog-wrap{margin-top:6px}
  .spotify-prog-track{height:2px;background:rgba(255,255,255,0.07);border-radius:2px}
  .spotify-prog-fill{height:100%;width:0%;background:linear-gradient(90deg,#1db954,#1ed760);border-radius:2px;transition:width .5s linear}
  .spotify-prog-times{display:flex;justify-content:space-between;font-family:'Geist Mono',monospace;font-size:.52rem;color:var(--muted);margin-top:3px}
  .no-activity{font-family:'Geist Mono',monospace;font-size:.6rem;color:rgba(102,128,168,0.4);letter-spacing:1px;text-transform:uppercase;text-align:center;padding:6px 0}
  #avatar-file,#pfp-file,#sp-bgfile,#sp-songfiles,#song-cover-file{display:none}
  select.sp-input option{background:#0c0f1e;color:var(--text)}
  .small-note{font-family:'Geist Mono',monospace;font-size:.54rem;color:var(--muted);letter-spacing:.5px;opacity:.6;margin-top:4px}

  /* ── ENTER SCREEN ── */
  #enter-screen{
    position:fixed;inset:0;z-index:9999;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;
    background:rgba(4,6,16,0.93);
    backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
    transition:opacity 1.1s cubic-bezier(0.4,0,0.2,1);
    overflow:hidden;
  }
  #enter-screen.hiding{ opacity:0; pointer-events:none; }
  #enter-screen.gone{ display:none; }

  /* stage holds the orbiting orbs + center dot */
  .enter-stage{
    position:relative;
    width:200px;height:200px;
    display:flex;align-items:center;justify-content:center;
  }

  /* ── HOLLOW PURPLE ORB BASE ── */
  .hp-orb{
    position:absolute;
    border-radius:50%;
    background:radial-gradient(circle at 38% 38%,
      rgba(8,4,20,0) 0%,
      rgba(4,2,14,0.96) 35%,
      rgba(2,1,10,0.99) 60%,
      transparent 100%
    );
  }
  .hp-orb::before{
    content:'';position:absolute;inset:-1px;border-radius:50%;
    animation:hpSpin 3.2s linear infinite;
  }
  .hp-orb::after{
    content:'';position:absolute;inset:4px;border-radius:50%;
    animation:hpSpin 2.1s linear infinite reverse;
  }
  @keyframes hpSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

  /* ORB 1 — blue (Infinity technique) */
  .hp-orb.o1{
    width:60px;height:60px;
    border:1.5px solid rgba(80,180,255,0.80);
    box-shadow:
      0 0 20px 3px rgba(80,180,255,0.60),
      0 0 50px 8px rgba(56,212,255,0.28),
      inset 0 0 16px 2px rgba(80,180,255,0.10);
    animation:orbitCW 4s linear infinite;
  }
  .hp-orb.o1::before{
    background:conic-gradient(from 0deg,
      transparent 0deg, rgba(80,180,255,0.5) 28deg,
      rgba(130,230,255,0.95) 55deg, transparent 82deg, transparent 360deg);
    mask:radial-gradient(circle,transparent 67%,black 69%,black 100%);
    -webkit-mask:radial-gradient(circle,transparent 67%,black 69%,black 100%);
  }
  .hp-orb.o1::after{
    background:conic-gradient(from 190deg,
      transparent 0deg, rgba(100,60,255,0.20) 22deg,
      rgba(80,180,255,0.35) 46deg, transparent 68deg, transparent 360deg);
    mask:radial-gradient(circle,transparent 50%,black 52%,black 82%,transparent 100%);
    -webkit-mask:radial-gradient(circle,transparent 50%,black 52%,black 82%,transparent 100%);
  }

  /* ORB 2 — red (Reversed Cursed Technique) */
  .hp-orb.o2{
    width:52px;height:52px;
    border:1.5px solid rgba(210,55,55,0.78);
    box-shadow:
      0 0 18px 3px rgba(210,55,55,0.58),
      0 0 42px 7px rgba(170,30,30,0.26),
      inset 0 0 14px 2px rgba(210,55,55,0.10);
    animation:orbitCCW 4s linear infinite;
  }
  .hp-orb.o2::before{
    background:conic-gradient(from 180deg,
      transparent 0deg, rgba(210,55,55,0.5) 28deg,
      rgba(255,100,80,0.90) 55deg, transparent 82deg, transparent 360deg);
    mask:radial-gradient(circle,transparent 65%,black 67%,black 100%);
    -webkit-mask:radial-gradient(circle,transparent 65%,black 67%,black 100%);
  }
  .hp-orb.o2::after{
    background:conic-gradient(from 10deg,
      transparent 0deg, rgba(80,20,160,0.18) 22deg,
      rgba(210,55,55,0.30) 46deg, transparent 68deg, transparent 360deg);
    mask:radial-gradient(circle,transparent 48%,black 50%,black 80%,transparent 100%);
    -webkit-mask:radial-gradient(circle,transparent 48%,black 50%,black 80%,transparent 100%);
  }

  /* clockwise and counter orbits — they pass through each other */
  @keyframes orbitCW{
    0%  {transform:translate( 68px,  0px)}
    25% {transform:translate(  0px, 68px)}
    50% {transform:translate(-68px,  0px)}
    75% {transform:translate(  0px,-68px)}
    100%{transform:translate( 68px,  0px)}
  }
  @keyframes orbitCCW{
    0%  {transform:translate(-68px,  0px)}
    25% {transform:translate(  0px,-68px)}
    50% {transform:translate( 68px,  0px)}
    75% {transform:translate(  0px, 68px)}
    100%{transform:translate(-68px,  0px)}
  }

  /* center core dot */
  .enter-core{
    position:relative;z-index:2;
    width:10px;height:10px;border-radius:50%;
    background:#50b4ff;
    box-shadow:0 0 14px 3px rgba(80,180,255,0.95),0 0 32px 6px rgba(56,212,255,0.5);
    animation:corePulse 2.6s ease-in-out infinite;
  }
  @keyframes corePulse{
    0%,100%{box-shadow:0 0 12px 2px rgba(80,180,255,0.85),0 0 26px 5px rgba(56,212,255,0.4)}
    50%    {box-shadow:0 0 20px 5px rgba(80,180,255,1.0),0 0 48px 10px rgba(56,212,255,0.7)}
  }

  .enter-label{
    font-family:'Geist Mono',monospace;
    font-size:0.60rem;letter-spacing:7px;text-transform:uppercase;
    color:rgba(80,180,255,0.55);
    animation:labelFade 2.6s ease-in-out infinite;
    user-select:none;
  }
  @keyframes labelFade{0%,100%{opacity:0.35}50%{opacity:0.85}}

  /* ── CLICK ACTIVATION ── */
  /* orbs slam together */
  #enter-screen.hp-activate .hp-orb.o1{
    animation:convergeA 0.55s cubic-bezier(0.6,0,0.4,1) forwards !important;
  }
  #enter-screen.hp-activate .hp-orb.o2{
    animation:convergeB 0.55s cubic-bezier(0.6,0,0.4,1) forwards !important;
  }
  @keyframes convergeA{to{transform:translate(0,0) scale(0);opacity:0}}
  @keyframes convergeB{to{transform:translate(0,0) scale(0);opacity:0}}

  /* hollow purple explosion — violet radial burst */
  .hp-burst{
    position:absolute;left:50%;top:50%;
    border-radius:50%;pointer-events:none;
    background:radial-gradient(circle,
      rgba(200,120,255,0.75) 0%,
      rgba(140,40,255,0.50) 30%,
      rgba(80,0,180,0.20) 60%,
      transparent 75%
    );
    width:10px;height:10px;
    transform:translate(-50%,-50%) scale(0);
    animation:hpBurst 0.85s cubic-bezier(0,0.7,0.3,1) forwards;
  }
  @keyframes hpBurst{
    0%  {transform:translate(-50%,-50%) scale(0);opacity:1}
    55% {opacity:0.9}
    100%{transform:translate(-50%,-50%) scale(35);opacity:0}
  }
  /* expanding ring shockwave */
  .enter-wave{
    position:fixed;border-radius:50%;pointer-events:none;z-index:9998;
    border:2px solid rgba(160,60,255,0.85);
    transform:translate(-50%,-50%);
    animation:eWave 0.85s cubic-bezier(0,0.55,0.4,1) forwards;
  }
  @keyframes eWave{
    0%  {width:14px;height:14px;opacity:1}
    100%{width:520px;height:520px;opacity:0}
  }
</style>
</head>
<body>

<div id="enter-screen">
  <div class="enter-stage">
    <div class="hp-orb o1"></div>
    <div class="hp-orb o2"></div>
    <div class="enter-core"></div>
  </div>
  <div class="enter-label">click to enter</div>
</div>

<div id="cursor-dot"></div>
<div id="cursor-ring"></div>
<canvas id="color-canvas" style="display:none"></canvas>

<video id="bg-video" autoplay loop muted playsinline></video>
<canvas id="bg-canvas"></canvas>
<div class="bg-overlay" id="bg-overlay"></div>

<div id="scene">
  <div class="card-wrap" id="card-wrap">
  <div class="card" id="card-el">
    <div class="banner" id="banner-el">
      <div class="banner-grid" id="banner-grid"></div>
      <div class="banner-glow" id="banner-glow"></div>
      <div class="banner-orb b1" id="orb1"></div>
      <div class="banner-orb b2" id="orb2"></div>
      <div class="banner-orb b3" id="orb3"></div>
    </div>
    <div class="profile-wrap">
      <div class="avatar-outer" id="avatar-outer">
        <div class="avatar-ring" id="avatar-ring"></div>
        <div class="avatar-img" id="avatar-el">
          <img id="avatar-img-el" src="" alt="" style="display:none" crossorigin="anonymous">
          <span id="avatar-fallback">pfp</span>
        </div>
        <div class="avatar-upload-hint">
          <svg viewBox="0 0 24 24"><path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0 2c-3.33 0-10 1.67-10 5v2h20v-2c0-3.33-6.67-5-10-5z"/></svg>
        </div>
        <div class="avatar-status" id="status-dot"></div>
      </div>
      <input type="file" id="avatar-file" accept="image/*" onchange="setAvatar(event)">
      <input type="file" id="pfp-file" accept="image/*" onchange="setAvatar(event)">
      <div class="profile-header">
        <div class="username-row">
          <span class="username" id="username-el">twistedtbh</span><span class="cursor-blink" id="cursor-blink-el"></span>
          <div class="badges" id="badges-el">
            <span class="badge">owner</span><span class="badge">mod</span><span class="badge">vip</span><span class="badge">pro</span>
          </div>
        </div>
        <div class="status-row">
          <div class="status-dot" id="status-dot2"></div>
          <span class="status-text" id="status-text-el">offline</span>
        </div>
        <div class="bio"><span id="bio-text"></span><span class="bio-cursor" id="bio-cursor-el"></span></div>
      </div>
      <div class="divider" id="divider-el"></div>
      <div class="socials">
        <a class="social-btn" href="#" id="s-github"><svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.44 9.8 8.2 11.37.6.11.82-.26.82-.58l-.01-2.03c-3.34.73-4.04-1.61-4.04-1.61-.54-1.38-1.33-1.75-1.33-1.75-1.09-.74.08-.73.08-.73 1.2.09 1.84 1.24 1.84 1.24 1.07 1.83 2.8 1.3 3.49 1 .11-.78.42-1.3.76-1.6-2.66-.3-5.46-1.33-5.46-5.93 0-1.31.47-2.38 1.24-3.22-.12-.3-.54-1.52.12-3.17 0 0 1.01-.32 3.3 1.23a11.5 11.5 0 0 1 3-.4c1.02 0 2.04.13 3 .4 2.28-1.55 3.29-1.23 3.29-1.23.66 1.65.24 2.87.12 3.17.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.63-5.48 5.92.43.37.81 1.1.81 2.22l-.01 3.29c0 .32.21.7.82.58C20.56 21.8 24 17.3 24 12c0-6.63-5.37-12-12-12z"/></svg>gh</a>
        <a class="social-btn" href="#" id="s-discord"><svg viewBox="0 0 24 24"><path d="M20.317 4.37a19.79 19.79 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057c.002.022.015.043.032.054a19.9 19.9 0 0 0 5.993 3.03.077.077 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>dc</a>
        <a class="social-btn" href="#" id="s-twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.746l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>x</a>
        <a class="social-btn" href="#" id="s-tiktok"><svg viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-2.88 2.5 2.89 2.89 0 0 1-2.89-2.89 2.89 2.89 0 0 1 2.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 0 0-.79-.05 6.34 6.34 0 0 0-6.34 6.34 6.34 6.34 0 0 0 6.34 6.34 6.34 6.34 0 0 0 6.33-6.34V8.69a8.26 8.26 0 0 0 4.84 1.55V6.79a4.85 4.85 0 0 1-1.07-.1z"/></svg>tt</a>
      </div>
      <div class="view-count"><div class="view-count-dot" id="view-dot"></div><span id="view-num">9,360</span> views</div>
    </div>
    <div class="music-section">
      <div class="music-label"><div class="music-eq" id="eq-el"></div>now playing</div>
      <div class="now-playing-row">
        <div class="album" id="album-art-el">
          <img id="album-cover-display" class="album-cover" src="" style="display:none" alt="" crossorigin="anonymous">
          <div class="album-initials" id="album-initials-el">--</div>
        </div>
        <div class="track-info">
          <div class="track-title" id="track-title-el">no track loaded</div>
          <div class="track-artist" id="track-artist-el">open settings to add songs</div>
          <div class="track-album" id="track-album-el"></div>
        </div>
      </div>
      <div class="prog-wrap" id="prog-wrap" onclick="seekAudio(event,this)">
        <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
        <div class="prog-times"><span id="t-cur">0:00</span><span id="t-total">0:00</span></div>
      </div>
      <div class="controls">
        <div class="ctrl" id="shuffle-c" onclick="toggleShuffle()"><svg viewBox="0 0 24 24"><path d="M16 3h5v5l-1.8-1.8-4.5 4.5-1.4-1.4 4.5-4.5L16 3zm-9.4.6L10 7l-3 3-1.4-1.4L9 5.4 7.4 3.8l-.8-.8zm1.5 10.4l1.4 1.4-4.5 4.5L6.8 21H2v-5l1.8 1.8 4.3-3.8zm7.3-.4l4.5 4.5 1.1-1.1V22h-5l1.2-1.2-4.5-4.5 1.7-1.7z"/></svg></div>
        <div class="ctrl" onclick="prevTrack()"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg></div>
        <div class="ctrl pp" id="pp-c" onclick="togglePlay()"><svg id="pp-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
        <div class="ctrl" onclick="nextTrack()"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm2-8.14L11.03 12 8 14.14V9.86zM16 6h2v12h-2z"/></svg></div>
        <div class="ctrl" id="repeat-c" onclick="toggleRepeat()"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></div>
      </div>
      <div class="song-selector" id="song-selector"></div>
      <div class="sliders-row">
        <div class="slider-group"><span class="slider-label" id="vol-label" onclick="toggleMute()">vol</span><input type="range" class="custom-slider" id="vol-sl" min="0" max="100" value="70" oninput="setVol(this.value)"></div>
        <div class="slider-group"><span class="slider-label" id="bright-label">dim</span><input type="range" class="custom-slider" id="bright-sl" min="0" max="100" value="50" oninput="setBrightness(this.value)"></div>
      </div>
    </div>
    <div class="presence-section">
      <div class="presence-label"><div class="presence-dc-dot" id="presence-dc-dot"></div>discord</div>
      <div class="activity-row hidden" id="act-custom" style="margin-bottom:5px;background:transparent;border-color:transparent;padding:0 2px 3px">
        <div class="activity-detail" id="act-custom-text" style="font-size:.68rem;color:rgba(180,200,240,0.5);font-style:italic"></div>
      </div>
      <div class="activity-row hidden" id="act-spotify" style="margin-bottom:6px">
        <div class="activity-img-wrap">
          <img class="activity-img" id="spotify-album-art" src="" alt="">
          <img class="activity-img-small" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Spotify_icon.svg/232px-Spotify_icon.svg.png" alt="">
        </div>
        <div class="activity-info">
          <div class="activity-name" id="spotify-song"></div>
          <div class="activity-detail" id="spotify-artist"></div>
          <div class="spotify-prog-wrap"><div class="spotify-prog-track"><div class="spotify-prog-fill" id="spotify-prog"></div></div><div class="spotify-prog-times"><span id="spotify-t-cur">0:00</span><span id="spotify-t-total">0:00</span></div></div>
        </div>
      </div>
      <div class="activity-row hidden" id="act-game">
        <div class="activity-img-wrap" style="display:flex;align-items:center;justify-content:center">
          <img class="activity-img" id="act-game-img" src="" alt="" style="display:none">
          <span id="act-game-initials" style="font-family:'Geist Mono',monospace;font-size:.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;text-align:center;line-height:1.2;padding:3px"></span>
        </div>
        <div class="activity-info">
          <div class="activity-name" id="act-game-name"></div>
          <div class="activity-detail" id="act-game-detail"></div>
          <div class="activity-state" id="act-game-state"></div>
        </div>
      </div>
      <div class="no-activity" id="act-idle">no activity</div>
    </div>
  </div>
  </div>
</div>

<div id="watermark">@twistedtbh</div>

<button class="gear-btn" onclick="requestAccess()">
  <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
  settings
</button>

<div class="overlay-base" id="pw-overlay">
  <div class="pw-box">
    <div class="pw-lock">access</div>
    <div class="pw-title">Owner Portal</div>
    <div class="pw-sub">enter password to edit</div>
    <div class="pw-error" id="pw-error"></div>
    <input class="pw-input" id="pw-input" type="password" placeholder="password" maxlength="32" onkeydown="if(event.key==='Enter')checkPw()">
    <button class="pw-btn" onclick="checkPw()">unlock</button>
    <div class="pw-cancel" onclick="closePw()">cancel</div>
  </div>
</div>

<div class="overlay-base" id="settings-overlay">
  <div class="settings-panel">
    <div class="sp-header"><div class="sp-title">Customize</div><div class="sp-close" onclick="closeSettings()">esc</div></div>
    <div class="sp-section">
      <div class="sp-section-title">Profile Picture</div>
      <div class="pfp-upload-row">
        <div class="pfp-preview-mini" id="pfp-mini"><img id="pfp-mini-img" src="" style="display:none" alt=""><span id="pfp-mini-txt">pfp</span></div>
        <button class="pfp-btn" onclick="document.getElementById('pfp-file').click()"><span>upload pfp</span>jpg · png · gif · webp</button>
      </div>
      <div style="margin-top:6px"><label class="sp-field-label">pfp url — paste catbox/imgur link (visible to everyone)</label><input class="sp-input" id="sp-pfpurl" placeholder="https://files.catbox.moe/..." maxlength="300"></div>
      <p class="small-note">upload is for your preview only — paste a public URL so all visitors see it</p>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">Profile</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
        <div><label class="sp-field-label">Username</label><input class="sp-input" id="sp-name" placeholder="twistedtbh" maxlength="24"></div>
        <div><label class="sp-field-label">Avatar fallback</label><input class="sp-input" id="sp-pfp" placeholder="pfp" maxlength="6"></div>
      </div>
      <div style="margin-bottom:8px"><label class="sp-field-label">Bio (typewriter)</label><input class="sp-input" id="sp-bio" placeholder=" T W I S T E D" maxlength="80"></div>
      <div style="margin-bottom:8px"><label class="sp-field-label">Tab title</label><input class="sp-input" id="sp-tab" placeholder="twstd" maxlength="40"></div>
      <div><label class="sp-field-label">Status</label><select class="sp-input" id="sp-status" style="cursor:none"><option value="offline">Offline</option><option value="online">Online</option><option value="dnd">Do Not Disturb</option></select></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">Badges</div>
      <div class="badge-grid" id="badge-grid"></div>
      <div class="badges-row-controls"><button class="badge-ctrl-btn" onclick="addBadgeSlot()">+ add badge</button><button class="badge-ctrl-btn" onclick="applyBadges()">preview</button></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">Social Links</div>
      <div style="display:grid;gap:6px">
        <div class="icon-edit-row"><span class="icon-edit-label">GitHub</span><input class="icon-edit-input" id="link-github" placeholder="https://github.com/..." maxlength="120"></div>
        <div class="icon-edit-row"><span class="icon-edit-label">Discord</span><input class="icon-edit-input" id="link-discord" placeholder="https://discord.gg/..." maxlength="120"></div>
        <div class="icon-edit-row"><span class="icon-edit-label">Twitter/X</span><input class="icon-edit-input" id="link-twitter" placeholder="https://x.com/..." maxlength="120"></div>
        <div class="icon-edit-row"><span class="icon-edit-label">TikTok</span><input class="icon-edit-input" id="link-tiktok" placeholder="https://tiktok.com/@..." maxlength="120"></div>
      </div>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">Slider Labels</div>
      <div class="icon-edit-row"><span class="icon-edit-label">Volume</span><span class="icon-edit-preview" id="prev-vol">vol</span><input class="icon-edit-input" id="edit-vol-icon" placeholder="vol" maxlength="6" oninput="document.getElementById('prev-vol').textContent=this.value||'vol'"></div>
      <div class="icon-edit-row"><span class="icon-edit-label">Brightness</span><span class="icon-edit-preview" id="prev-bright">dim</span><input class="icon-edit-input" id="edit-bright-icon" placeholder="dim" maxlength="6" oninput="document.getElementById('prev-bright').textContent=this.value||'dim'"></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">Background Video</div>
      <input class="sp-input" id="sp-bgurl" placeholder="https://... (.mp4/.webm)" style="margin-bottom:6px">
      <button class="sp-upload" onclick="document.getElementById('sp-bgfile').click()"><span>upload video file</span>.mp4 / .webm</button>
      <input type="file" id="sp-bgfile" accept="video/*" onchange="uploadBg(event)">
    </div>
    <div class="sp-section">
      <div class="sp-section-title">Music</div>
      <button class="sp-upload" onclick="document.getElementById('sp-songfiles').click()"><span>upload audio files</span>.mp3 .ogg .wav .m4a</button>
      <input type="file" id="sp-songfiles" accept="audio/*" multiple onchange="uploadSongs(event)">
      <div style="margin-top:12px">
        <div class="sp-section-title" style="font-size:.5rem;margin-bottom:8px">bulk import from urls</div>
        <div class="song-add-form" style="margin-bottom:12px">
          <label class="sp-field-label">paste catbox/external urls — one per line — metadata auto-read</label>
          <textarea class="sp-input" id="sp-bulkurls" rows="4" placeholder="https://files.catbox.moe/abc.mp3&#10;https://files.catbox.moe/def.mp3" style="resize:vertical;font-size:.7rem;line-height:1.6"></textarea>
          <button class="sp-add-btn" style="width:100%;margin-top:8px" onclick="bulkImportSongs()">import & read metadata</button>
        </div>
        <div class="sp-section-title" style="font-size:.5rem;margin-bottom:8px">add song manually</div>
        <div class="song-add-form">
          <div class="song-form-row-with-img">
            <div><label class="sp-field-label">cover art</label><div class="song-cover-preview" id="song-cover-preview" onclick="document.getElementById('song-cover-file').click()"><span id="song-cover-text">add<br>img</span><img id="song-cover-img" src="" style="display:none" alt=""></div><input type="file" id="song-cover-file" accept="image/*" onchange="setSongCoverPreview(event)"></div>
            <div style="flex:1;display:grid;gap:6px">
              <div><label class="sp-field-label">title *</label><input class="sp-input" id="sp-songtitle" placeholder="Track name" maxlength="60"></div>
              <div><label class="sp-field-label">artist</label><input class="sp-input" id="sp-songartist" placeholder="Artist name" maxlength="60"></div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px">
            <div><label class="sp-field-label">album</label><input class="sp-input" id="sp-songalbum" placeholder="Album name" maxlength="60"></div>
            <div><label class="sp-field-label">year</label><input class="sp-input" id="sp-songyear" placeholder="2024" maxlength="4"></div>
          </div>
          <div style="margin-top:6px"><label class="sp-field-label">audio url</label><div class="sp-row"><input class="sp-input" id="sp-songurl" placeholder="https://..."><button class="sp-add-btn" onclick="addSongUrl()">add</button></div></div>
        </div>
      </div>
      <div class="song-list-sp" id="song-list-sp" style="margin-top:10px"></div>
    </div>
    <div class="sp-section">
      <div class="sp-section-title">Security</div>
      <div class="sp-row"><input class="sp-input" type="password" id="sp-newpw" placeholder="New password..." maxlength="32"><button class="sp-add-btn" onclick="changePw()">set</button></div>
    </div>
    <button class="sp-save" onclick="saveSettings()">save &amp; publish changes</button>
    <p class="small-note" style="text-align:center;margin-top:8px">changes visible to all visitors</p>
  </div>
</div>

<script>
// ── CURSOR ──
const cursorDot=document.getElementById('cursor-dot'),cursorRing=document.getElementById('cursor-ring');
let mouseX=innerWidth/2,mouseY=innerHeight/2,ringX=mouseX,ringY=mouseY;
const TRAIL=22,trailDots=[];
for(let i=0;i<TRAIL;i++){const d=document.createElement('div');d.className='trail-dot';const sz=Math.max(1.5,7-i*0.22);d.style.cssText=`width:${sz}px;height:${sz}px;opacity:0;background:#50b4ff`;document.body.appendChild(d);trailDots.push({el:d,x:mouseX,y:mouseY})}
document.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY;cursorDot.style.left=mouseX+'px';cursorDot.style.top=mouseY+'px'});
(function loopCursor(){ringX+=(mouseX-ringX)*0.1;ringY+=(mouseY-ringY)*0.1;cursorRing.style.left=ringX+'px';cursorRing.style.top=ringY+'px';for(let i=TRAIL-1;i>0;i--){trailDots[i].x=trailDots[i-1].x;trailDots[i].y=trailDots[i-1].y}trailDots[0].x=mouseX;trailDots[0].y=mouseY;trailDots.forEach((t,i)=>{t.el.style.opacity=(1-i/TRAIL)*0.55;t.el.style.left=t.x+'px';t.el.style.top=t.y+'px';t.el.style.transform=`translate(-50%,-50%) scale(${Math.max(0.05,1-i*0.045)})`});requestAnimationFrame(loopCursor)})();

// ── TILT ──
const cardWrap=document.getElementById('card-wrap');
let tiltX=0,tiltY=0,floatA=0;
(function loopTilt(){floatA+=0.016;const fy=Math.sin(floatA)*5,fx=Math.cos(floatA*0.65)*2.5;const nx=(mouseX-innerWidth/2)/(innerWidth/2),ny=(mouseY-innerHeight/2)/(innerHeight/2);tiltX+=(ny*-13-tiltX)*0.065;tiltY+=(nx*13-tiltY)*0.065;cardWrap.style.transform=`translate(${nx*20+fx}px,${ny*14+fy}px) rotateX(${tiltX}deg) rotateY(${tiltY}deg)`;requestAnimationFrame(loopTilt)})();

// ── STATE ──
let OWNER_PW='twisted123',isAuthed=false,songs=[],curTrack=-1,playing=false,shuf=false,rep=false,muted=false;
const audio=new Audio();
let views=9360,badgeData=['owner','mod','vip','pro'],volLabel='vol',brightLabel='dim',currentStatus='offline';
let socialLinks={github:'#',discord:'#',twitter:'#',tiktok:'#'},pendingSongCoverBlob=null,storedAvatarDataUrl='',storedPfpUrl='';

// ── PALETTE STATE ──
let pal=[[80,180,255],[56,212,255],[144,220,255]];
let bgEnergy=0,currentEnergy=0,bassEnergy=0,avgEnergyHist=0.05,lastBeat=0;

// ── COLOR EXTRACTION ──
function extractFromDataUrl(dataUrl, cb){
  if(!dataUrl||!dataUrl.startsWith('data:')){ cb(null); return; }
  const img=new Image();
  img.onload=()=>{
    try{
      const S=64,cc=document.getElementById('color-canvas');
      cc.width=S;cc.height=S;
      const cx=cc.getContext('2d',{willReadFrequently:true});
      cx.clearRect(0,0,S,S);cx.drawImage(img,0,0,S,S);
      let data;try{data=cx.getImageData(0,0,S,S).data;}catch(e){cb(null);return;}

      function sample(minSat, minBright, maxBright){
        const px=[];
        for(let i=0;i<data.length;i+=4){
          const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
          if(a<120)continue;
          const mx=Math.max(r,g,b),mn=Math.min(r,g,b);
          const sat=mx>0?(mx-mn)/mx:0,bright=mx/255;
          if(sat<minSat||bright<minBright||bright>maxBright)continue;
          // Boost dark saturated colors so they show up on dark covers
          const boostedR=Math.min(255,Math.round(r*1.6));
          const boostedG=Math.min(255,Math.round(g*1.6));
          const boostedB=Math.min(255,Math.round(b*1.6));
          px.push({r:boostedR,g:boostedG,b:boostedB,score:sat*0.7+bright*0.3});
        }
        return px;
      }

      // Try strict first, relax for dark covers
      let pixels = sample(0.20, 0.10, 0.96);
      if(pixels.length < 6) pixels = sample(0.10, 0.04, 0.98); // relax for dark art
      if(pixels.length < 3) pixels = sample(0.03, 0.02, 0.99); // very dark/monochrome

      if(pixels.length<2){ cb(null); return; }
      pixels.sort((a,b)=>b.score-a.score);
      const picked=[pixels[0]];
      for(const px of pixels){
        let ok=true;
        for(const q of picked){if(Math.sqrt((px.r-q.r)**2+(px.g-q.g)**2+(px.b-q.b)**2)<50){ok=false;break;}}
        if(ok)picked.push(px);
        if(picked.length>=3)break;
      }
      // Pad with hue-shifted variants if cover is very monochrome
      while(picked.length<3){
        const b=picked[0];
        const hShift=picked.length*60;
        picked.push({r:Math.min(255,b.g+hShift%180),g:Math.min(255,b.b),b:Math.min(255,b.r+hShift%120)});
      }
      cb(picked.map(c=>[c.r,c.g,c.b]));
    }catch(e){cb(null);}
  };
  img.onerror=()=>cb(null);
  img.src=dataUrl;
}
function extractPalette(imgEl){ return null; }
function pastel([r,g,b],s=0.08){return[Math.round(r*(1-s)+255*s),Math.round(g*(1-s)+255*s),Math.round(b*(1-s)+255*s)]}
function hex([r,g,b]){return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('')}

function applyPalette(raw){
  if(!raw||raw.length<3)return;
  pal=raw.map(c=>pastel(c));
  const [p1,p2,p3]=pal,h1=hex(p1),h2=hex(p2),h3=hex(p3);
  const R=document.documentElement;
  R.style.setProperty('--accent',h1);R.style.setProperty('--accent2',h2);R.style.setProperty('--accent3',h3);
  R.style.setProperty('--glow',`rgba(${p1[0]},${p1[1]},${p1[2]},0.18)`);
  R.style.setProperty('--border',`rgba(${p1[0]},${p1[1]},${p1[2]},0.15)`);
  R.style.setProperty('--c1r',p1[0]);R.style.setProperty('--c1g',p1[1]);R.style.setProperty('--c1b',p1[2]);
  R.style.setProperty('--c2r',p2[0]);R.style.setProperty('--c2g',p2[1]);R.style.setProperty('--c2b',p2[2]);
  R.style.setProperty('--c3r',p3[0]);R.style.setProperty('--c3g',p3[1]);R.style.setProperty('--c3b',p3[2]);
  // banner
  document.getElementById('banner-el').style.background=`linear-gradient(135deg,rgba(${p2[0]},${p2[1]},${p2[2]},0.16) 0%,rgba(${p1[0]},${p1[1]},${p1[2]},0.11) 50%,rgba(${p3[0]},${p3[1]},${p3[2]},0.08) 100%)`;
  document.getElementById('banner-grid').style.backgroundImage=`linear-gradient(rgba(${p1[0]},${p1[1]},${p1[2]},0.07) 1px,transparent 1px),linear-gradient(90deg,rgba(${p2[0]},${p2[1]},${p2[2]},0.07) 1px,transparent 1px)`;
  document.getElementById('banner-glow').style.background=`radial-gradient(ellipse at 50% 170%,rgba(${p1[0]},${p1[1]},${p1[2]},0.25) 0%,transparent 55%)`;
  document.getElementById('orb1').style.background=`rgba(${p1[0]},${p1[1]},${p1[2]},0.38)`;
  document.getElementById('orb2').style.background=`rgba(${p3[0]},${p3[1]},${p3[2]},0.28)`;
  document.getElementById('orb3').style.background=`rgba(${p2[0]},${p2[1]},${p2[2]},0.22)`;
  // avatar ring
  document.getElementById('avatar-ring').style.background=`conic-gradient(${h1},${h2},${h3},${h1})`;
  // progress
  document.getElementById('prog-fill').style.background=`linear-gradient(90deg,${h1},${h2},${h3})`;
  // eq colors
  const eqCols=[h1,h2,h3,h1,h2,h3,h1];
  document.querySelectorAll('.eq-b').forEach((b,i)=>b.style.background=eqCols[i]);
  // cursor
  cursorDot.style.background=h1;cursorDot.style.boxShadow=`0 0 8px ${h1}`;
  cursorRing.style.borderColor=`rgba(${p1[0]},${p1[1]},${p1[2]},0.5)`;
  const tCols=[h1,h2,h3,h1,h2,h3,h1,h2];
  trailDots.forEach((t,i)=>t.el.style.background=tCols[i%tCols.length]);
  // misc
  document.getElementById('view-dot').style.background=h2;
  document.getElementById('bio-cursor-el').style.background=h2;
  document.getElementById('cursor-blink-el').style.background=h1;
  document.getElementById('divider-el').style.background=`linear-gradient(90deg,transparent,rgba(${p1[0]},${p1[1]},${p1[2]},0.18),rgba(${p2[0]},${p2[1]},${p2[2]},0.18),transparent)`;
  document.getElementById('card-el').style.boxShadow=`0 0 0 1px rgba(${p1[0]},${p1[1]},${p1[2]},0.07),0 40px 90px rgba(0,0,0,0.35),0 0 80px rgba(${p1[0]},${p1[1]},${p1[2]},0.16),inset 0 1px 0 rgba(255,255,255,0.05)`;
  const wm=document.getElementById('watermark');
  wm.style.color=`rgba(${p1[0]},${p1[1]},${p1[2]},0.28)`;
  wm.style.textShadow=`0 0 12px rgba(${p1[0]},${p1[1]},${p1[2]},0.38)`;
  // badge colors
  document.querySelectorAll('.badge').forEach(b=>{b.style.background=`rgba(${p1[0]},${p1[1]},${p1[2]},0.07)`;b.style.borderColor=`rgba(${p1[0]},${p1[1]},${p1[2]},0.15)`;b.style.color=`rgba(${p1[0]},${p1[1]},${p1[2]},0.68)`});
  // particles color indices
  [...dust,...nodes,...bright,...aurora].forEach(p=>p.ci=Math.floor(Math.random()*3));
}

// ── WEB AUDIO ──
let audioCtx=null,analyser=null,audioSrc=null,freqData=null;
function setupAnalyzer(){
  try {
    if(audioCtx){
      if(audioCtx.state==='suspended') audioCtx.resume();
      // Rebuild gainNode if somehow missing
      if(entered) buildGainNode();
      return;
    }
    audioCtx = new(window.AudioContext||window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.76;
    if(!audioSrc){
      audioSrc = audioCtx.createMediaElementSource(audio);
      audioSrc.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
    freqData = new Uint8Array(analyser.frequencyBinCount);
    // Build gain node — muffled if not entered yet, full if already entered
    buildGainNode();
    if(entered && gainNode) gainNode.gain.value = 1.0;
    audioReactLoop();
  } catch(e) {
    audioCtx = null;
  }
}
function avgR(s,e){if(!freqData)return 0;let sum=0,n=0;for(let i=s;i<Math.min(e,freqData.length);i++){sum+=freqData[i];n++}return n?sum/n:0}
function audioReactLoop(){
  requestAnimationFrame(audioReactLoop);
  if(!analyser||!freqData)return;
  if(audioCtx.state==='suspended')audioCtx.resume();
  analyser.getByteFrequencyData(freqData);
  const N=freqData.length,bass=avgR(0,5),low=avgR(5,15),mid=avgR(15,40),hi=avgR(40,N);
  const energy=(bass*0.5+low*0.25+mid*0.15+hi*0.1)/255;
  currentEnergy=currentEnergy*0.75+energy*0.25;
  bassEnergy=bassEnergy*0.72+(bass/255)*0.28;
  avgEnergyHist=avgEnergyHist*0.965+energy*0.035;
  bgEnergy=currentEnergy;
  // EQ from real freq data
  const eqBars=document.querySelectorAll('.eq-b');
  eqBars.forEach((bar,i)=>{const bin=Math.floor(i*(N*0.5)/eqBars.length),val=freqData[bin]||0;bar.style.height=(playing?Math.max(2,val/255*14):2)+'px';bar.style.opacity=playing?0.35+(val/255)*0.65:0.22});
  if(!playing)return;
  const [r,g,b]=pal[0],[r2,g2,b2]=pal[1];
  // card glow
  const gs=50+currentEnergy*110,ga=0.08+currentEnergy*0.38,ba=0.05+bassEnergy*0.22;
  document.getElementById('card-el').style.boxShadow=`0 0 0 1px rgba(${r},${g},${b},${ba}),0 40px 90px rgba(0,0,0,0.35),0 0 ${gs}px rgba(${r},${g},${b},${ga}),inset 0 1px 0 rgba(255,255,255,0.05)`;
  // prog glow
  document.getElementById('prog-fill').style.boxShadow=`0 0 ${5+currentEnergy*22}px rgba(${r},${g},${b},${0.28+currentEnergy*0.52})`;
  // ring speed
  document.getElementById('avatar-ring').style.animationDuration=Math.max(0.5,5-currentEnergy*7)+'s';
  // orb scale
  document.getElementById('orb1').style.transform=`scale(${1+bassEnergy*0.65})`;
  document.getElementById('orb2').style.transform=`scale(${1+(mid/255)*0.55})`;
  document.getElementById('orb3').style.transform=`scale(${1+(hi/255)*0.45})`;
  document.getElementById('banner-glow').style.background=`radial-gradient(ellipse at 50% 170%,rgba(${r},${g},${b},${0.18+bassEnergy*0.32}) 0%,transparent 55%)`;
  // beat
  const now=Date.now();
  if(energy>avgEnergyHist*1.42&&bass>85&&(now-lastBeat)>200){
    lastBeat=now;
    document.getElementById('card-el').style.boxShadow=`0 0 0 2px rgba(${r},${g},${b},0.75),0 40px 90px rgba(0,0,0,0.32),0 0 120px rgba(${r},${g},${b},0.55),inset 0 1px 0 rgba(255,255,255,0.08)`;
    const alb=document.getElementById('album-art-el');alb.style.transition='transform 0.04s,box-shadow 0.04s';alb.style.transform='scale(1.1)';alb.style.boxShadow=`0 0 30px rgba(${r},${g},${b},0.5)`;
    setTimeout(()=>{alb.style.transform='';alb.style.boxShadow='';alb.style.transition='all .3s'},130);
    document.getElementById('orb1').style.transform=`scale(${1.6+bassEnergy*0.3})`;
    setTimeout(()=>document.getElementById('orb1').style.transform='',200);
  }
}

// ── PARTICLE BG ──
const canvas=document.getElementById('bg-canvas'),ctx=canvas.getContext('2d');
let bgActive=true;
function resC(){canvas.width=innerWidth;canvas.height=innerHeight}resC();window.addEventListener('resize',resC);

// ── PARTICLE TIERS ──
const dust=Array.from({length:260},()=>({
  x:Math.random()*innerWidth, y:Math.random()*innerHeight,
  vx:(Math.random()-.5)*.14, vy:(Math.random()-.5)*.14,
  r:Math.random()*.5+.07, ci:Math.floor(Math.random()*3),
  phase:Math.random()*Math.PI*2
}));

const nodes=Array.from({length:115},()=>({
  x:Math.random()*innerWidth, y:Math.random()*innerHeight,
  vx:(Math.random()-.5)*.19, vy:(Math.random()-.5)*.19,
  r:Math.random()*1.2+.4, ci:Math.floor(Math.random()*3),
  phase:Math.random()*Math.PI*2
}));

const bright=Array.from({length:22},()=>({
  x:Math.random()*innerWidth, y:Math.random()*innerHeight,
  vx:(Math.random()-.5)*.09, vy:(Math.random()-.5)*.09,
  r:Math.random()*2.4+1.5, ci:Math.floor(Math.random()*3),
  phase:Math.random()*Math.PI*2
}));

// T4: aurora blobs — each assigned a freq band (0=bass,1=mid,2=hi)
// so they individually swell to their own frequency, not just overall energy
const aurora=Array.from({length:10},()=>({
  x:Math.random()*innerWidth, y:Math.random()*innerHeight,
  vx:(Math.random()-.5)*.055, vy:(Math.random()-.5)*.055,
  rx:Math.random()*260+140, ry:Math.random()*160+90,
  ci:Math.floor(Math.random()*3),       // palette color index
  band:Math.floor(Math.random()*3),     // freq band: 0=bass 1=mid 2=hi
  phase:Math.random()*Math.PI*2,
  // smooth per-blob color channels — blends toward live palette color
  cr:80, cg:180, cb:255
}));

// Per-freq smoothed energies for aurora blob reactivity
let freqBass=0, freqMid=0, freqHi=0;

let bgSmooth=0, bgWave=0, bgFlash=0, bgFrame=0;

(function drawBg(){
  if(!bgActive)return;
  bgFrame++;

  bgSmooth += (bgEnergy      - bgSmooth) * 0.016;
  bgWave   += (currentEnergy - bgWave)   * 0.032;
  bgFlash  += (bassEnergy    - bgFlash)  * 0.12;

  // Per-band smoothers for aurora blobs
  if(freqData){
    const N=freqData.length;
    const rawBass=(freqData[0]+freqData[1]+freqData[2]+freqData[3]+freqData[4])/5/255;
    const rawMid=Array.from({length:25},(_,i)=>freqData[15+i]).reduce((a,b)=>a+b,0)/25/255;
    const rawHi=Array.from({length:20},(_,i)=>freqData[40+i]).reduce((a,b)=>a+b,0)/20/255;
    freqBass += (rawBass - freqBass) * 0.10;
    freqMid  += (rawMid  - freqMid)  * 0.08;
    freqHi   += (rawHi   - freqHi)   * 0.07;
  }
  const bandEnergy=[freqBass, freqMid, freqHi];

  const fade = Math.max(0.72, Math.min(0.94, 0.84 + bgSmooth*0.05 - bgFlash*0.07));
  ctx.fillStyle=`rgba(8,14,30,${fade})`;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Live palette — read every frame so blobs react instantly to album art changes
  const palRGB=[pal[0]||[80,180,255], pal[1]||[56,212,255], pal[2]||[144,220,255]];
  const spFast = 0.70 + bgSmooth*0.40 + bgFlash*0.28;
  const spSlow = 0.26 + bgSmooth*0.14 + bgFlash*0.08;

  // ── T4: AURORA BLOBS ──
  // Each blob smoothly interpolates its own RGB toward its assigned palette color,
  // and swells in radius based on its own frequency band energy
  ctx.save();
  aurora.forEach(p=>{
    // Smooth color toward live palette (drift speed ~0.03 per frame = ~1s to fully shift)
    const [tr,tg,tb]=palRGB[p.ci%3];
    p.cr += (tr - p.cr) * 0.03;
    p.cg += (tg - p.cg) * 0.03;
    p.cb += (tb - p.cb) * 0.03;
    const r=Math.round(p.cr), g=Math.round(p.cg), b=Math.round(p.cb);

    // Blob swells with its own freq band
    const be = bandEnergy[p.band] || 0;
    const breathe = 1 + Math.sin(bgFrame*0.005+p.phase)*0.16 + bgSmooth*0.18 + be*0.55;
    const alpha   = 0.06 + bgSmooth*0.07 + bgFlash*0.04 + be*0.10;

    const W=p.rx*breathe, H=p.ry*breathe;
    const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,W);
    grad.addColorStop(0,   `rgba(${r},${g},${b},${alpha})`);
    grad.addColorStop(0.45,`rgba(${r},${g},${b},${alpha*0.38})`);
    grad.addColorStop(1,   `rgba(${r},${g},${b},0)`);
    ctx.scale(1, H/W);
    ctx.fillStyle=grad;
    ctx.beginPath();ctx.arc(p.x, p.y*(W/H), W, 0, Math.PI*2);ctx.fill();
    ctx.setTransform(1,0,0,1,0,0);

    p.x+=p.vx*spSlow; p.y+=p.vy*spSlow;
    if(p.x<-300)p.x=canvas.width+300; if(p.x>canvas.width+300)p.x=-300;
    if(p.y<-200)p.y=canvas.height+200; if(p.y>canvas.height+200)p.y=-200;
  });
  ctx.restore();

  // ── T2: NETWORK NODES + lines ──
  const lineA=0.025+bgWave*0.040;
  const nGlow=5+bgSmooth*11+bgFlash*9;
  const nAlpha=0.42+bgSmooth*0.28+bgFlash*0.16;
  const CONN=125;
  for(let i=0;i<nodes.length;i++){
    const p=nodes[i];const[r,g,b]=palRGB[p.ci%3];
    for(let j=i+1;j<nodes.length;j++){
      const q=nodes[j];const dx=p.x-q.x,dy=p.y-q.y,d2=dx*dx+dy*dy;
      if(d2<CONN*CONN){const d=Math.sqrt(d2);
        ctx.strokeStyle=`rgba(${r},${g},${b},${lineA*(1-d/CONN)})`;
        ctx.lineWidth=0.45;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(q.x,q.y);ctx.stroke();
      }
    }
  }
  nodes.forEach(p=>{
    const[r,g,b]=palRGB[p.ci%3];
    const breathe=1+Math.sin(bgFrame*0.011+p.phase)*0.13+bgSmooth*0.20;
    ctx.globalAlpha=nAlpha;ctx.shadowBlur=nGlow;ctx.shadowColor=`rgb(${r},${g},${b})`;
    ctx.fillStyle=`rgb(${r},${g},${b})`;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r*breathe,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;ctx.shadowBlur=0;
    p.x+=p.vx*spFast;p.y+=p.vy*spFast;
    if(p.x<0||p.x>canvas.width)p.vx*=-1;if(p.y<0||p.y>canvas.height)p.vy*=-1;
  });

  // ── T3: BRIGHT ACCENT nodes ──
  const bGlow=10+bgSmooth*18+bgFlash*14;
  const bAlpha=0.72+bgSmooth*0.20+bgFlash*0.08;
  bright.forEach(p=>{
    const[r,g,b]=palRGB[p.ci%3];
    const breathe=1+Math.sin(bgFrame*0.008+p.phase)*0.20+bgSmooth*0.28;
    ctx.globalAlpha=bAlpha;ctx.shadowBlur=bGlow;ctx.shadowColor=`rgb(${r},${g},${b})`;
    ctx.fillStyle=`rgb(${r},${g},${b})`;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r*breathe,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;ctx.shadowBlur=0;
    p.x+=p.vx*spFast;p.y+=p.vy*spFast;
    if(p.x<0||p.x>canvas.width)p.vx*=-1;if(p.y<0||p.y>canvas.height)p.vy*=-1;
  });

  // ── T1: MICRO DUST ──
  const dAlpha=0.28+bgSmooth*0.20+bgFlash*0.12;
  dust.forEach(p=>{
    const[r,g,b]=palRGB[p.ci%3];
    const twinkle=0.3+0.7*Math.abs(Math.sin(bgFrame*0.016+p.phase));
    ctx.globalAlpha=dAlpha*twinkle;ctx.fillStyle=`rgb(${r},${g},${b})`;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
    p.x+=p.vx*spFast;p.y+=p.vy*spFast;
    if(p.x<0||p.x>canvas.width)p.vx*=-1;if(p.y<0||p.y>canvas.height)p.vy*=-1;
  });

  requestAnimationFrame(drawBg);
})();
// ── TYPEWRITER ──
let tabTexts=['twstd'],tIdx=0,tCh=0,tDel=false;
function runTypeTab(){const t=tabTexts[tIdx%tabTexts.length];if(!tDel){tCh++;const c=t.slice(0,tCh);document.title=c+'|';setTimeout(()=>{document.title=c;if(tCh>=t.length){tDel=true;setTimeout(runTypeTab,2200)}else setTimeout(runTypeTab,155)},115)}else{tCh--;const c=t.slice(0,tCh);document.title=c.length?c:'|';if(tCh<=0){tDel=false;tIdx++;setTimeout(runTypeTab,650)}else setTimeout(runTypeTab,85)}}
runTypeTab();
let bioTexts=[' T W I S T E D'],bIdx=0,bCh=0,bDel=false;
function typeBio(){const t=bioTexts[bIdx%bioTexts.length],el=document.getElementById('bio-text');if(!bDel){el.textContent=t.slice(0,++bCh);if(bCh>=t.length){bDel=true;setTimeout(typeBio,3200)}else setTimeout(typeBio,110)}else{el.textContent=t.slice(0,--bCh);if(bCh<=0){bDel=false;bIdx++;setTimeout(typeBio,600)}else setTimeout(typeBio,55)}}
setTimeout(typeBio,1000);

// EQ bars init
const eqEl=document.getElementById('eq-el');
for(let i=0;i<7;i++){const b=document.createElement('div');b.className='eq-b';b.style.height='2px';eqEl.appendChild(b)}
(function idleEQ(){if(!playing){eqEl.querySelectorAll('.eq-b').forEach(b=>{b.style.height='2px';b.style.opacity='.2'})}setTimeout(idleEQ,800)})();

// ── ALBUM DISPLAY + COLOR EXTRACTION ──
function updateAlbumDisplay(s){
  const coverEl=document.getElementById('album-cover-display'),ini=document.getElementById('album-initials-el');
  if(s&&s.coverSrc){
    coverEl.removeAttribute('crossorigin');
    ini.style.display='none';
    coverEl.style.display='block';
    coverEl.src=s.coverSrc;
    extractFromDataUrl(s.coverSrc, p=>{ if(p&&p.length>=3) applyPalette(p); });
  }else if(s){
    coverEl.style.display='none';ini.style.display='flex';
    const p=[(s.artist||'').split(' ')[0]?.[0]||'',(s.album||s.name||'').split(' ')[0]?.[0]||''].filter(Boolean);
    ini.textContent=p.length?p.join('').toUpperCase():'--';
    applyPalette([[80,180,255],[56,212,255],[144,220,255]]);
  }else{coverEl.style.display='none';ini.style.display='flex';ini.textContent='--'}
}

// ── MUSIC ENGINE ──
// pendingPlay: true means user hit play and we're waiting for audio to be ready
let pendingPlay = false;

function renderSelector(){
  const el=document.getElementById('song-selector');
  el.innerHTML='';
  songs.forEach((s,i)=>{
    const d=document.createElement('div');
    d.className='song-dot'+(i===curTrack?' active':'');
    d.textContent=String(i+1).padStart(2,'0');
    d.title=s.name;
    d.onclick=()=>playTrack(i);
    el.appendChild(d);
  });
  if(!songs.length) el.innerHTML='<span style="font-family:\'Geist Mono\',monospace;font-size:.56rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase">no songs — add via settings</span>';
}

function updateTrackUI(s){
  document.getElementById('track-title-el').textContent  = s.name || 'unknown';
  document.getElementById('track-artist-el').textContent = s.artist || 'unknown artist';
  document.getElementById('track-album-el').textContent  = s.album ? (s.album+(s.year?' · '+s.year:'')) : '';
  document.getElementById('prog-fill').style.width = '0%';
  document.getElementById('t-cur').textContent  = '0:00';
  document.getElementById('t-total').textContent = '0:00';
}

function loadTrack(i){
  if(!songs[i]) return;
  curTrack = i;
  const s = songs[i];
  pendingPlay = false;
  // NEVER set crossOrigin on blob/data URLs — browsers reject it
  audio.removeAttribute('crossorigin');
  audio.src = s.url;
  audio.volume = Math.max(0, Math.min(1, (document.getElementById('vol-sl').value||70)/100));
  updateTrackUI(s);
  updateAlbumDisplay(s);
  renderSelector();
}

function doPlay(){
  if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
  const p = audio.play();
  if(p !== undefined){
    p.then(()=>{
      playing = true;
      pendingPlay = false;
      updPP();
      try{ setupAnalyzer(); }catch(e){}
      // Make sure gain is up if we've entered
      if(entered && gainNode) gainNode.gain.value = 1.0;
    }).catch(err=>{
      playing = false;
      pendingPlay = false;
      updPP();
      if(err.name === 'NotAllowedError') toast('tap play again');
      else if(err.name === 'NotSupportedError') toast('format not supported');
      else if(err.name === 'AbortError') {}
      else toast('play error: '+err.message.slice(0,40));
    });
  }
}

function playTrack(i){
  if(!songs[i]) return;
  // If same track and already playing, just restart
  if(i === curTrack && playing){ audio.currentTime=0; return; }
  loadTrack(i);
  pendingPlay = true;
  // Don't call play() immediately — wait for canplay event
  // (audio.load() is implicit when src changes)
}

function togglePlay(){
  if(!songs.length){ requestAccess(); return; }
  if(curTrack === -1){ playTrack(0); return; }
  if(playing){
    audio.pause();
    playing = false;
    pendingPlay = false;
    updPP();
  } else {
    // Resume AudioContext on user gesture if needed
    if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
    pendingPlay = true;
    doPlay();
  }
}

function updPP(){
  document.getElementById('pp-icon').innerHTML = playing
    ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
    : '<path d="M8 5v14l11-7z"/>';
  document.getElementById('album-art-el').className = 'album'+(playing?' playing':'');
}

function nextTrack(){ if(!songs.length)return; playTrack(shuf?Math.floor(Math.random()*songs.length):(curTrack+1)%songs.length); }
function prevTrack(){ if(!songs.length)return; if(audio.currentTime>3){audio.currentTime=0;return;} playTrack((curTrack-1+songs.length)%songs.length); }
function toggleShuffle(){ shuf=!shuf; document.getElementById('shuffle-c').className='ctrl'+(shuf?' on':''); }
function toggleRepeat(){ rep=!rep; document.getElementById('repeat-c').className='ctrl'+(rep?' on':''); }
function setVol(v){ audio.volume=v/100; muted=v==0; document.getElementById('vol-label').textContent=v==0?'mute':v<40?'low':volLabel; }
function toggleMute(){ muted=!muted; if(muted){audio.volume=0;document.getElementById('vol-sl').value=0;document.getElementById('vol-label').textContent='mute';}else{audio.volume=.7;document.getElementById('vol-sl').value=70;document.getElementById('vol-label').textContent=volLabel;} }
function seekAudio(e,el){ if(!audio.duration)return; const r=el.querySelector('.prog-track').getBoundingClientRect(); audio.currentTime=((e.clientX-r.left)/r.width)*audio.duration; }
function setBrightness(v){ document.getElementById('bg-overlay').style.opacity=.4+(1-v/100)*.6; }
function fmt(s){ if(!s||isNaN(s))return'0:00'; return Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0'); }

// Audio events — these are the only reliable way to drive playback
audio.addEventListener('canplay', ()=>{
  // canplay fires when there's enough data to start
  if(pendingPlay){
    doPlay();
  }
});
audio.addEventListener('timeupdate', ()=>{
  if(!audio.duration) return;
  document.getElementById('prog-fill').style.width = (audio.currentTime/audio.duration*100)+'%';
  document.getElementById('t-cur').textContent  = fmt(audio.currentTime);
  document.getElementById('t-total').textContent = fmt(audio.duration);
});
audio.addEventListener('ended', ()=>{
  playing = false;
  if(rep){ audio.currentTime=0; pendingPlay=true; audio.play().then(()=>{playing=true;updPP();}).catch(()=>{}); }
  else nextTrack();
});
audio.addEventListener('error', ()=>{
  playing = false;
  pendingPlay = false;
  updPP();
  const codes = {1:'aborted',2:'network error',3:'decode error',4:'format not supported'};
  const msg = audio.error ? (codes[audio.error.code]||'unknown') : 'unknown error';
  toast('audio error: '+msg);
});
audio.addEventListener('waiting', ()=>{ /* buffering — could show spinner here */ });

// ── PROFILE PICTURE ──
function setAvatar(e){
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const MAX=220;let w=img.width,h=img.height;
      if(w>MAX||h>MAX){const sc=Math.min(MAX/w,MAX/h);w=Math.round(w*sc);h=Math.round(h*sc)}
      const c=document.createElement('canvas');c.width=w;c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      const url=c.toDataURL('image/jpeg',0.88);
      const imgEl=document.getElementById('avatar-img-el');imgEl.src=url;imgEl.style.display='block';
      document.getElementById('avatar-fallback').style.display='none';
      const m=document.getElementById('pfp-mini-img');m.src=url;m.style.display='block';
      document.getElementById('pfp-mini-txt').style.display='none';
      storedAvatarDataUrl=url;
      savePfpToIDB();saveToStorage();toast('profile picture updated');
    };img.src=ev.target.result;
  };reader.readAsDataURL(f);
}
// pfp only changeable via settings

// ── PASSWORD ──
function requestAccess(){if(isAuthed){openSettings();return}document.getElementById('pw-input').value='';document.getElementById('pw-error').textContent='';document.getElementById('pw-overlay').classList.add('open');setTimeout(()=>document.getElementById('pw-input').focus(),80)}
function checkPw(){const v=document.getElementById('pw-input').value;if(v===OWNER_PW){isAuthed=true;document.getElementById('pw-overlay').classList.remove('open');openSettings()}else{const i=document.getElementById('pw-input');i.classList.remove('shake');void i.offsetWidth;i.classList.add('shake');document.getElementById('pw-error').textContent='incorrect password';setTimeout(()=>{i.classList.remove('shake');document.getElementById('pw-error').textContent=''},2000)}}
function closePw(){document.getElementById('pw-overlay').classList.remove('open')}
function changePw(){const n=document.getElementById('sp-newpw').value.trim();if(!n){toast('enter a new password');return}OWNER_PW=n;document.getElementById('sp-newpw').value='';toast('password updated')}

// ── BADGES ──
function renderBadgeGrid(){const g=document.getElementById('badge-grid');if(!g)return;g.innerHTML='';badgeData.forEach((b,i)=>{const s=document.createElement('div');s.className='badge-slot';s.innerHTML=`<div class="badge-slot-preview" id="bprev-${i}">${b||'?'}</div><input class="badge-slot-input" id="binp-${i}" value="${b}" placeholder="text" maxlength="10" oninput="document.getElementById('bprev-${i}').textContent=this.value||'?'"><button class="badge-rm-btn" onclick="rmBadge(${i})">x</button>`;g.appendChild(s)})}
function addBadgeSlot(){badgeData.push('new');renderBadgeGrid()}
function rmBadge(i){badgeData.splice(i,1);renderBadgeGrid();applyBadges()}
function applyBadges(){badgeData=Array.from(document.querySelectorAll('[id^="binp-"]')).map(e=>e.value.trim()).filter(Boolean);renderBadgesOnCard();toast('badges updated')}
function setSongCoverPreview(e){const f=e.target.files[0];if(!f)return;pendingSongCoverBlob=f;const i=document.getElementById('song-cover-img');i.src=URL.createObjectURL(f);i.style.display='block';document.getElementById('song-cover-text').style.display='none'}

// ── SETTINGS ──
function openSettings(){
  document.getElementById('settings-overlay').classList.add('open');
  document.getElementById('sp-name').value=document.getElementById('username-el').textContent;
  document.getElementById('sp-bio').value=bioTexts[0]||'';
  document.getElementById('sp-tab').value=tabTexts[0]||'';
  document.getElementById('sp-status').value=currentStatus;
  document.getElementById('edit-vol-icon').value=volLabel;
  document.getElementById('edit-bright-icon').value=brightLabel;
  document.getElementById('prev-vol').textContent=volLabel;
  document.getElementById('prev-bright').textContent=brightLabel;
  document.getElementById('link-github').value=socialLinks.github==='#'?'':socialLinks.github;
  document.getElementById('link-discord').value=socialLinks.discord==='#'?'':socialLinks.discord;
  document.getElementById('link-twitter').value=socialLinks.twitter==='#'?'':socialLinks.twitter;
  document.getElementById('link-tiktok').value=socialLinks.tiktok==='#'?'':socialLinks.tiktok;
  const pfpUrlInp = document.getElementById('sp-pfpurl');
  if(pfpUrlInp) pfpUrlInp.value = storedPfpUrl || '';
  const as=document.getElementById('avatar-img-el').src;
  if(as&&as.length>50){const m=document.getElementById('pfp-mini-img');m.src=as;m.style.display='block';document.getElementById('pfp-mini-txt').style.display='none'}
  renderBadgeGrid();renderSongListSP();
}
function closeSettings(){document.getElementById('settings-overlay').classList.remove('open')}
function saveSettings(){
  const name=document.getElementById('sp-name').value.trim()||'twistedtbh';
  const bio=document.getElementById('sp-bio').value.trim();
  const tab=document.getElementById('sp-tab').value.trim()||name;
  const status=document.getElementById('sp-status').value;
  const pfp=document.getElementById('sp-pfp').value.trim();
  const bgurl=document.getElementById('sp-bgurl').value.trim();
  const nv=document.getElementById('edit-vol-icon').value.trim();
  const nb=document.getElementById('edit-bright-icon').value.trim();
  document.getElementById('username-el').textContent=name;
  if(bio){bioTexts=[bio];bIdx=0;bCh=0;bDel=false;document.getElementById('bio-text').textContent='';setTimeout(typeBio,400)}
  if(tab){tabTexts=[tab];tIdx=0;tCh=0;tDel=false;setTimeout(runTypeTab,400)}
  if(pfp)document.getElementById('avatar-fallback').textContent=pfp;
  const pfpUrlVal=(document.getElementById('sp-pfpurl')||{value:''}).value.trim();
  if(pfpUrlVal){storedPfpUrl=pfpUrlVal;applyPfpUrl(storedPfpUrl);}
  if(nv){volLabel=nv;document.getElementById('vol-label').textContent=nv}
  if(nb){brightLabel=nb;document.getElementById('bright-label').textContent=nb}
  const gv=id=>{const x=document.getElementById(id).value.trim();return x||'#'};
  socialLinks={github:gv('link-github'),discord:gv('link-discord'),twitter:gv('link-twitter'),tiktok:gv('link-tiktok')};
  ['github','discord','twitter','tiktok'].forEach(k=>document.getElementById('s-'+k).href=socialLinks[k]);
  applyBadges();
  const sc={offline:'#f0a8b4',online:'#a8f0c6',dnd:'#f0d8a0'};const col=sc[status]||'#f0a8b4';
  currentStatus=status;document.getElementById('status-dot').style.background=col;document.getElementById('status-dot2').style.background=col;
  document.getElementById('status-text-el').textContent=status==='dnd'?'do not disturb':status;
  if(bgurl)setVideo(bgurl);
  views+=Math.floor(Math.random()*10)+1;document.getElementById('view-num').textContent=views.toLocaleString();
  saveToStorage();closeSettings();toast('saved & published');
}
function setVideo(url){const v=document.getElementById('bg-video');v.src=url;v.style.display='block';bgActive=false;canvas.style.display='none'}
function uploadBg(e){const f=e.target.files[0];if(!f)return;setVideo(URL.createObjectURL(f));toast('video background set')}
function readMp3Tags(file, idx){
  // Try ID3 via jsmediatags
  if(typeof jsmediatags === 'undefined') return;
  try {
    jsmediatags.read(file, {
      onSuccess(tag){
        const t = tag.tags;
        const s = songs[idx];
        if(!s) return;
        if(t.title)  s.name   = t.title;
        if(t.artist) s.artist = t.artist;
        if(t.album)  s.album  = t.album;
        if(t.year)   s.year   = String(t.year);
        // Extract embedded album art
        if(t.picture){
          const pic = t.picture;
          const bytes = new Uint8Array(pic.data);
          const blob = new Blob([bytes], {type: pic.format || 'image/jpeg'});
          // Convert to data URL so canvas color extraction can read it (blob URLs taint canvas)
          const fr2 = new FileReader();
          fr2.onload = ev => {
            if(songs[idx]) songs[idx].coverSrc = ev.target.result;
            if(idx === curTrack) updateAlbumDisplay(songs[idx]);
          };
          fr2.readAsDataURL(blob);
        }
        // Re-render everything if this is the active track
        if(idx === curTrack){
          document.getElementById('track-title-el').textContent  = s.name;
          document.getElementById('track-artist-el').textContent = s.artist || 'unknown artist';
          document.getElementById('track-album-el').textContent  = s.album ? (s.album + (s.year ? ' · ' + s.year : '')) : '';
          updateAlbumDisplay(s);
        }
        renderSelector();
        renderSongListSP();
      },
      onError(err){ /* silent — file may lack ID3 tags */ }
    });
  } catch(e) {}
}
function fileToDataUrl(file){
  return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(file);});
}
function uploadSongs(e){
  const files=Array.from(e.target.files);
  if(!files.length)return;
  const startIdx=songs.length;
  // Push all songs first so indices are stable
  files.forEach(f=>{
    songs.push({url:URL.createObjectURL(f),b64:'',name:f.name.replace(/\.[^.]+$/,''),artist:'',album:'',year:'',coverSrc:''});
  });
  renderSelector();renderSongListSP();
  if(curTrack===-1&&songs.length)loadTrack(startIdx);
  // Convert ALL files to b64 in parallel, save ONCE when all done
  const promises=files.map((f,fi)=>{
    const idx=startIdx+fi;
    // Read ID3 tags async
    if(typeof jsmediatags!=='undefined'){
      try{jsmediatags.read(f,{
        onSuccess(tag){
          const t=tag.tags,s=songs[idx];if(!s)return;
          if(t.title)s.name=t.title;if(t.artist)s.artist=t.artist;
          if(t.album)s.album=t.album;if(t.year)s.year=String(t.year);
          if(t.picture){
            const bytes=new Uint8Array(t.picture.data);
            const blob=new Blob([bytes],{type:t.picture.format||'image/jpeg'});
            const fr=new FileReader();
            fr.onload=ev=>{if(songs[idx])songs[idx].coverSrc=ev.target.result;if(idx===curTrack)updateAlbumDisplay(songs[idx]);};
            fr.readAsDataURL(blob);
          }
          if(idx===curTrack){
            document.getElementById('track-title-el').textContent=s.name;
            document.getElementById('track-artist-el').textContent=s.artist||'unknown artist';
            document.getElementById('track-album-el').textContent=s.album?(s.album+(s.year?' · '+s.year:'')):'';
            if(!t.picture)updateAlbumDisplay(s);
          }
          renderSelector();renderSongListSP();
        },onError(){}
      });}catch(err){}
    }
    // Return b64 promise
    return fileToDataUrl(f).then(b64=>{
      if(songs[idx]){songs[idx].b64=b64;songs[idx].url=b64;}
    }).catch(()=>{});
  });
  // Save ONCE after ALL conversions finish
  Promise.all(promises).then(()=>{
    saveSongsToIDB();
    saveToStorage();
    toast(files.length+' song'+(files.length>1?'s':'')+' saved ✓');
  });
  toast('songs added locally — use catbox URLs for global sharing');
  e.target.value='';
}
async function fetchTagsFromUrl(url){
  // Fetch the audio binary then pass it to jsmediatags as a Blob.
  // This works even when jsmediatags can't read the URL directly (CORS header issues).
  if(typeof jsmediatags === 'undefined') return null;
  try {
    const res = await fetch(url);
    if(!res.ok) return null;
    const buf = await res.arrayBuffer();
    const blob = new Blob([buf]);
    return await new Promise(resolve => {
      jsmediatags.read(blob, {
        onSuccess(tag){
          const t = tag.tags;
          if(t.picture){
            const bytes = new Uint8Array(t.picture.data);
            const picBlob = new Blob([bytes], {type: t.picture.format||'image/jpeg'});
            const fr = new FileReader();
            fr.onload = ev => resolve({
              name: t.title||'', artist: t.artist||'',
              album: t.album||'', year: t.year ? String(t.year) : '',
              coverSrc: ev.target.result
            });
            fr.readAsDataURL(picBlob);
          } else {
            resolve({ name: t.title||'', artist: t.artist||'', album: t.album||'', year: t.year ? String(t.year) : '', coverSrc: '' });
          }
        },
        onError(){ resolve(null); }
      });
    });
  } catch(e){ return null; }
}

async function bulkImportSongs(){
  const ta = document.getElementById('sp-bulkurls');
  const urls = (ta.value||'').split('\n').map(s=>s.trim()).filter(s=>s.startsWith('http'));
  if(!urls.length){ toast('paste at least one URL'); return; }
  toast('reading metadata for '+urls.length+' songs...');
  const btn = ta.nextElementSibling;
  if(btn) btn.disabled = true;
  let added = 0;
  for(const url of urls){
    const raw = decodeURIComponent(url.split('/').pop().split('?')[0]).replace(/\.[^.]+$/,'');
    const fallbackName = raw || ('Track '+(songs.length+1));
    // Try to read ID3 tags
    const tags = await fetchTagsFromUrl(url);
    const song = {
      url,
      b64: '',
      name:      (tags && tags.name)      || fallbackName,
      artist:    (tags && tags.artist)    || '',
      album:     (tags && tags.album)     || '',
      year:      (tags && tags.year)      || '',
      coverSrc:  (tags && tags.coverSrc)  || ''
    };
    songs.push(song);
    added++;
    renderSelector();
    renderSongListSP();
    if(curTrack === -1) loadTrack(0);
  }
  ta.value = '';
  if(btn) btn.disabled = false;
  // Push to Firebase — all visitors get these songs
  await saveSongsToIDB();
  await saveToStorage();
  toast(added+' song'+(added>1?'s':'')+' imported ✓ visible to all');
}

function addSongUrl(){
  const url=document.getElementById('sp-songurl').value.trim();
  if(!url){toast('enter a URL first');return;}
  const raw=url.split('/').pop().split('?')[0];
  const t=document.getElementById('sp-songtitle').value.trim()||(raw?decodeURIComponent(raw).replace(/\.[^.]+$/,''):'Track '+(songs.length+1));
  let cs='';
  if(pendingSongCoverBlob)cs=URL.createObjectURL(pendingSongCoverBlob);
  const newIdx=songs.length;
  songs.push({url,name:t,artist:document.getElementById('sp-songartist').value.trim(),album:document.getElementById('sp-songalbum').value.trim(),year:document.getElementById('sp-songyear').value.trim(),coverSrc:cs});
  ['sp-songurl','sp-songtitle','sp-songartist','sp-songalbum','sp-songyear'].forEach(id=>document.getElementById(id).value='');
  pendingSongCoverBlob=null;
  document.getElementById('song-cover-img').style.display='none';
  document.getElementById('song-cover-text').style.display='';
  renderSelector();renderSongListSP();
  const wasEmpty=curTrack===-1;
  loadTrack(wasEmpty?newIdx:curTrack);
  // Save to Firebase so all visitors get this song
  saveSongsToIDB();
  saveToStorage();
  toast(wasEmpty?'song added — hit play!':'song added ✓ visible to all');
}
function removeSong(i){songs.splice(i,1);if(curTrack>=songs.length)curTrack=songs.length-1;renderSelector();renderSongListSP();saveSongsToIDB();saveToStorage();}
function renderSongListSP(){const el=document.getElementById('song-list-sp');el.innerHTML='';songs.forEach((s,i)=>{const d=document.createElement('div');d.className='song-sp-row';const m=[s.artist,s.album,s.year].filter(Boolean).join(' · ')||'no metadata';d.innerHTML=`<span class="song-sp-num">${String(i+1).padStart(2,'0')}</span><div class="song-sp-info"><div class="song-sp-title">${s.name}</div><div class="song-sp-meta">${m}</div></div><button class="song-sp-rm" onclick="removeSong(${i})">rm</button>`;el.appendChild(d)});if(!songs.length)el.innerHTML='<div style="font-family:\'Geist Mono\',monospace;font-size:.62rem;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">no songs yet</div>'}

// ── STORAGE ──
// ── STORAGE: IndexedDB (no size limit) ──
// Stores profile settings in 'meta' store, each song as a separate record in 'songs' store
// Falls back to localStorage for tiny metadata if IDB unavailable
let _idb = null;
function openIDB(){
  if(_idb) return Promise.resolve(_idb);
  return new Promise((res,rej)=>{
    const req=indexedDB.open('snow_profile',2);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('meta'))  db.createObjectStore('meta');
      if(!db.objectStoreNames.contains('songs')) db.createObjectStore('songs',{keyPath:'id',autoIncrement:true});
    };
    req.onsuccess=e=>{ _idb=e.target.result; res(_idb); };
    req.onerror=()=>rej(req.error);
  });
}
function idbPut(store,key,val){
  return openIDB().then(db=>new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    if(store==='meta') tx.objectStore(store).put(val,key);
    else tx.objectStore(store).put(val);
    tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);
  }));
}
function idbGet(store,key){
  return openIDB().then(db=>new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);
  }));
}
function idbGetAll(store){
  return openIDB().then(db=>new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).getAll();
    req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);
  }));
}
function idbClear(store){
  return openIDB().then(db=>new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);
  }));
}
async function storageSave(key,val){
  try{ await idbPut('meta',key,val); return; }catch(e){}
  try{ localStorage.setItem(key,val); }catch(e){}
}
async function storageLoad(key){
  try{ const v=await idbGet('meta',key); if(v!=null) return v; }catch(e){}
  try{ return localStorage.getItem(key); }catch(e){ return null; }
}
async function saveToStorage(){
  // Strip songs down to URL-only so Firebase can store them (no base64 blobs)
  // Only songs with real external URLs go to Firebase (catbox, etc.)
  // Songs uploaded as files stay in IndexedDB (local only — too large for Firebase)
  const songsMeta = songs
    .filter(s => s.url && s.url.startsWith('http'))
    .map(s => ({
      url: s.url,
      name: s.name||'', artist: s.artist||'',
      album: s.album||'', year: s.year||'',
      // Only keep coverSrc if it's also an external URL (not base64)
      coverSrc: (s.coverSrc && s.coverSrc.startsWith('http')) ? s.coverSrc : ''
    }));

  const publicMeta = {
    username: document.getElementById('username-el').textContent,
    bio: bioTexts[0]||'', tab: tabTexts[0]||'', status: currentStatus,
    badges: badgeData, volLabel, brightLabel,
    pfpText: document.getElementById('avatar-fallback').textContent,
    socialLinks,
    pfpUrl: storedPfpUrl || '',   // public URL (catbox/imgur) — works on all devices
    songs: songsMeta              // catbox URLs — streams on all devices, no 60MB download
  };

  // Push to Firebase — all visitors see this immediately on any device
  if(window._fbSet){
    try{ await window._fbSet(publicMeta); }catch(e){ console.warn('Firebase save failed',e); }
  }
  // Also save locally as fallback
  try{ await storageSave('profile_v5_meta', JSON.stringify({...publicMeta, views})); }catch(e){}
}

function applyPfpUrl(url){
  if(!url) return;
  const i = document.getElementById('avatar-img-el');
  i.removeAttribute('crossorigin');
  i.src = url; i.style.display = 'block';
  document.getElementById('avatar-fallback').style.display = 'none';
  const m = document.getElementById('pfp-mini-img');
  if(m){ m.src=url; m.style.display='block'; }
  const mt = document.getElementById('pfp-mini-txt');
  if(mt) mt.style.display='none';
}

async function savePfpToIDB(){
  // Save local base64 so settings panel preview works for the owner
  try{
    const src = storedAvatarDataUrl || '';
    if(src && src.startsWith('data:')) await storageSave('profile_pfp', src);
  }catch(e){}
}

async function loadPfpFromIDB(){
  // Only used for the owner's settings preview — not for global display
  try{
    const src = await storageLoad('profile_pfp');
    if(src && src.length > 50){
      storedAvatarDataUrl = src;
      const m = document.getElementById('pfp-mini-img');
      if(m){ m.src=src; m.style.display='block'; }
      const mt = document.getElementById('pfp-mini-txt');
      if(mt) mt.style.display='none';
    }
  }catch(e){}
}

async function saveSongsToIDB(){
  // Saves full songs array (with b64 audio) to IDB songs store
  // Each song gets its own record — no size limits, all or nothing atomically
  try {
    await idbClear('songs');
    for(const s of songs){
      const url = s.b64||(s.url&&!s.url.startsWith('blob:')?s.url:'');
      if(!url) continue;
      await idbPut('songs','_unused_',{
        url, name:s.name||'', artist:s.artist||'',
        album:s.album||'', year:s.year||'',
        coverSrc:s.coverSrc&&!s.coverSrc.startsWith('blob:')?s.coverSrc:''
      });
    }
  } catch(e) { console.error('saveSongs failed',e); }
}
window.applyProfileData = function applyProfileData(d){
  if(!d) return;
  if(d.username) document.getElementById('username-el').textContent = d.username;
  if(d.bio) bioTexts = [d.bio];
  if(d.tab) tabTexts = [d.tab];
  if(d.badges && d.badges.length) { badgeData = d.badges; renderBadgesOnCard(); }
  if(d.volLabel) { volLabel = d.volLabel; document.getElementById('vol-label').textContent = d.volLabel; }
  if(d.brightLabel) { brightLabel = d.brightLabel; document.getElementById('bright-label').textContent = d.brightLabel; }
  if(d.views) views = d.views;
  if(d.pfpText) document.getElementById('avatar-fallback').textContent = d.pfpText;
  if(d.status) {
    currentStatus = d.status;
    const sc = {offline:'#f0a8b4',online:'#a8f0c6',dnd:'#f0d8a0'};
    const col = sc[d.status] || '#f0a8b4';
    document.getElementById('status-dot').style.background = col;
    document.getElementById('status-dot2').style.background = col;
    document.getElementById('status-text-el').textContent = d.status==='dnd' ? 'do not disturb' : d.status;
  }
  if(d.socialLinks) {
    socialLinks = d.socialLinks;
    ['github','discord','twitter','tiktok'].forEach(k=>{
      const el=document.getElementById('s-'+k);
      if(el){ el.href=socialLinks[k]||'#'; el.target='_blank'; el.rel='noopener noreferrer'; }
    });
  }
  // PFP as a public URL (catbox/imgur) — loads on ALL devices globally
  if(d.pfpUrl && d.pfpUrl.length > 8){
    storedPfpUrl = d.pfpUrl;
    applyPfpUrl(d.pfpUrl);
  }
  // Songs as catbox URLs — streams on all devices without downloading 60MB
  if(d.songs && Array.isArray(d.songs) && d.songs.length){
    songs = d.songs.map(s=>({
      url: s.url, b64:'', name: s.name||'', artist: s.artist||'',
      album: s.album||'', year: s.year||'', coverSrc: s.coverSrc||''
    }));
    renderSelector();
    if(curTrack === -1) loadTrack(0);
  }
};
// Flush any Firebase data that arrived before applyProfileData was defined
if(window._fbPending){ window.applyProfileData(window._fbPending); window._fbPending=null; }

async function loadFromStorage(){
  // Local fallback only — Firebase onValue handles live global updates for all visitors
  try {
    const str = await storageLoad('profile_v5_meta');
    if(!str) return;
    const d = JSON.parse(str);
    if(d) applyProfileData(d);
  } catch(e) {}
}

function renderBadgesOnCard(){const el=document.getElementById('badges-el');if(!el)return;el.innerHTML='';badgeData.forEach(b=>{const s=document.createElement('span');s.className='badge';s.textContent=b;el.appendChild(s)});const [p1]=pal;document.querySelectorAll('.badge').forEach(b=>{b.style.background=`rgba(${p1[0]},${p1[1]},${p1[2]},0.07)`;b.style.borderColor=`rgba(${p1[0]},${p1[1]},${p1[2]},0.15)`;b.style.color=`rgba(${p1[0]},${p1[1]},${p1[2]},0.68)`})}
function toast(msg){const ex=document.querySelector('.toast');if(ex)ex.remove();const el=document.createElement('div');el.className='toast';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>el.remove(),2700)}
document.addEventListener('keydown',e=>{const tag=document.activeElement.tagName;if(tag==='INPUT'||tag==='SELECT')return;if(e.code==='Space'){e.preventDefault();togglePlay()}if(e.code==='ArrowRight')nextTrack();if(e.code==='ArrowLeft')prevTrack();if(e.key==='Escape'){closeSettings();closePw()}});
document.getElementById('pw-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('pw-overlay'))closePw()});
document.getElementById('settings-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('settings-overlay'))closeSettings()});

// ── DISCORD PRESENCE ──
const DISCORD_ID='1240409640647266314';
let lanyardWS=null,lanyardHB=null,spotifyInterval=null,spotifyTimestamps=null;
const dcStatusColors={online:'#a8f0c6',idle:'#f0d8a0',dnd:'#f0a8b4',offline:'#6090b8'};
function showEl(id){document.getElementById(id).classList.remove('hidden')}
function hideEl(id){document.getElementById(id).classList.add('hidden')}
function fmtMs(ms){if(!ms||ms<0)return'0:00';const s=Math.floor(ms/1000);return Math.floor(s/60)+':'+String(s%60).padStart(2,'0')}
function updateSpotifyProgress(){if(!spotifyTimestamps)return;const now=Date.now(),el=now-spotifyTimestamps.start,tot=spotifyTimestamps.end-spotifyTimestamps.start;document.getElementById('spotify-prog').style.width=Math.min(100,(el/tot)*100)+'%';document.getElementById('spotify-t-cur').textContent=fmtMs(el);document.getElementById('spotify-t-total').textContent=fmtMs(tot)}
function applyPresence(data){
  const status=data.discord_status||'offline',col=dcStatusColors[status]||dcStatusColors.offline;
  document.getElementById('presence-dc-dot').style.background=col;
  document.getElementById('status-dot').style.background=col;document.getElementById('status-dot2').style.background=col;
  document.getElementById('status-text-el').textContent={online:'online',idle:'idle',dnd:'do not disturb',offline:'offline'}[status]||status;
  const ca=(data.activities||[]).find(a=>a.type===4);
  if(ca&&(ca.state||ca.emoji?.name)){document.getElementById('act-custom-text').textContent=[ca.emoji?.name,ca.state].filter(Boolean).join(' ');showEl('act-custom')}else hideEl('act-custom');
  clearInterval(spotifyInterval);
  if(data.listening_to_spotify&&data.spotify){const sp=data.spotify;document.getElementById('spotify-song').textContent=sp.song;document.getElementById('spotify-artist').textContent=sp.artist?'by '+sp.artist:'';document.getElementById('spotify-album-art').src=sp.album_art_url||'';spotifyTimestamps=sp.timestamps||null;updateSpotifyProgress();spotifyInterval=setInterval(updateSpotifyProgress,1000);showEl('act-spotify')}else{spotifyTimestamps=null;hideEl('act-spotify')}
  const ga=(data.activities||[]).find(a=>a.type===0||a.type===1||a.type===3);
  if(ga){document.getElementById('act-game-name').textContent=ga.name||'';document.getElementById('act-game-detail').textContent=ga.details||'';document.getElementById('act-game-state').textContent=ga.state||'';const imgEl=document.getElementById('act-game-img'),init=document.getElementById('act-game-initials'),aid=ga.application_id,li=ga.assets?.large_image;if(aid&&li){const src=li.startsWith('mp:external/')?'https://media.discordapp.net/external/'+li.replace('mp:external/',''):`https://cdn.discordapp.com/app-assets/${aid}/${li}.png`;imgEl.src=src;imgEl.style.display='block';init.style.display='none';imgEl.onerror=()=>{imgEl.style.display='none';init.style.display='';init.textContent=(ga.name||'?').slice(0,3).toUpperCase()}}else{imgEl.style.display='none';init.style.display='';init.textContent=(ga.name||'?').slice(0,3).toUpperCase()}showEl('act-game')}else hideEl('act-game');
  document.getElementById('act-idle').style.display=(data.listening_to_spotify||!!ga)?'none':'';
}
function connectLanyard(){
  if(lanyardWS)lanyardWS.close();
  lanyardWS=new WebSocket('wss://api.lanyard.rest/socket');
  lanyardWS.onmessage=e=>{const msg=JSON.parse(e.data);if(msg.op===1){clearInterval(lanyardHB);lanyardHB=setInterval(()=>{if(lanyardWS.readyState===1)lanyardWS.send(JSON.stringify({op:3}))},msg.d.heartbeat_interval);lanyardWS.send(JSON.stringify({op:2,d:{subscribe_to_id:DISCORD_ID}}))}if(msg.op===0&&(msg.t==='INIT_STATE'||msg.t==='PRESENCE_UPDATE')){const d=msg.t==='INIT_STATE'?msg.d[DISCORD_ID]:msg.d;if(d)applyPresence(d)}};
  lanyardWS.onclose=()=>{clearInterval(lanyardHB);setTimeout(connectLanyard,5000)};
  lanyardWS.onerror=()=>lanyardWS.close();
}

// ── INIT ──
try { applyPalette([[80,180,255],[56,212,255],[144,220,255]]); } catch(e) {}
try { renderSelector(); } catch(e) {}
(async()=>{
  // Firebase onValue fires within ~300ms and calls applyProfileData with songs+pfp URLs
  // so visitors on any device/browser get everything from catbox automatically.
  // We just increment views locally — no IDB song loading needed for visitors.
  try { views++; document.getElementById('view-num').textContent = views.toLocaleString(); } catch(e) {}
  // Owner only: load their local settings as instant fallback before Firebase responds
  try { await loadFromStorage(); } catch(e) {}
})();
try { fetch(`https://api.lanyard.rest/v1/users/${DISCORD_ID}`).then(r=>r.json()).then(j=>{if(j.success&&j.data)applyPresence(j.data)}).catch(()=>{}); } catch(e) {}
try { connectLanyard(); } catch(e) {}

// ── ENTER SCREEN ──
let entered = false;
let gainNode = null;

function buildGainNode(){
  if(!audioCtx || gainNode) return;
  try{
    gainNode = audioCtx.createGain();
    analyser.disconnect();
    analyser.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    gainNode.gain.value = 0.10; // muffled behind enter screen
  }catch(e){}
}

// Boot audio as soon as page loads — plays muffled behind the enter screen
// This requires the AudioContext to be created on first user interaction,
// so we pre-load the audio element silently and play on click
(async function preloadAudio(){
  try{
    if(songs.length && curTrack === -1) loadTrack(0);
    // Set src and preload but don't play yet — browser won't block this
    if(songs.length && songs[0]) audio.src = songs[0].url;
    audio.preload = 'auto';
  }catch(e){}
})();

function enterSite(e){
  if(entered) return;
  entered = true;
  const screen = document.getElementById('enter-screen');
  const cx = e ? e.clientX : innerWidth/2;
  const cy = e ? e.clientY : innerHeight/2;

  // Step 1: orbs converge toward center
  screen.classList.add('hp-activate');

  // Step 2: ~400ms later — hollow purple burst + shockwave rings
  setTimeout(()=>{
    // Violet burst from center of stage
    const stage = screen.querySelector('.enter-stage');
    if(stage){
      const burst = document.createElement('div');
      burst.className = 'hp-burst';
      stage.appendChild(burst);
    }
    // 3 purple shockwave rings expanding from click pos
    for(let i=0;i<3;i++){
      const w = document.createElement('div');
      w.className='enter-wave';
      w.style.cssText=`left:${cx}px;top:${cy}px;animation-delay:${i*0.11}s`;
      document.body.appendChild(w);
      setTimeout(()=>w.remove(), 1000);
    }
    // Ramp audio up
    if(gainNode && audioCtx){
      gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
      gainNode.gain.setValueAtTime(gainNode.gain.value, audioCtx.currentTime);
      gainNode.gain.linearRampToValueAtTime(1.0, audioCtx.currentTime + 1.0);
    } else {
      audio.volume = document.getElementById('vol-sl').value / 100;
    }
  }, 400);

  // Step 3: fade screen away after burst
  setTimeout(()=>{
    screen.classList.add('hiding');
    setTimeout(()=>screen.classList.add('gone'), 1200);
  }, 620);
}

async function onEnterClick(e){
  // User gesture — now we can start AudioContext and play
  try{
    if(songs.length && curTrack === -1) loadTrack(0);

    if(!audioCtx){
      audioCtx = new(window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize=256; analyser.smoothingTimeConstant=0.76;
      if(!audioSrc){
        audioSrc = audioCtx.createMediaElementSource(audio);
        audioSrc.connect(analyser);
        analyser.connect(audioCtx.destination);
      }
      freqData = new Uint8Array(analyser.frequencyBinCount);
      audioReactLoop();
    } else if(audioCtx.state==='suspended'){
      await audioCtx.resume();
    }

    buildGainNode(); // sets gain to 0.10 (muffled)

    if(songs.length && !playing){
      audio.volume = 1.0; // gain node controls actual volume
      await audio.play();
      playing = true; updPP();
    }
  }catch(err){}

  enterSite(e);
}

const enterEl = document.getElementById('enter-screen');
enterEl.addEventListener('click', onEnterClick);
document.addEventListener('keydown', ev=>{
  if(!entered && (ev.code==='Enter'||ev.code==='Space')){
    ev.preventDefault(); onEnterClick(null);
  }
});

</script>
</body>
</html>
